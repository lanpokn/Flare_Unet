è®°å¿†æŒ‘é”™ï¼š
# Voxelç¼–è§£ç å·¥å…·é“¾ - é¡¹ç›®è®°å½•

## é¡¹ç›®æ¦‚è¿°

æˆåŠŸå®ç°äº†æ¨¡å—åŒ–çš„Eventsâ†”Voxelç¼–è§£ç å·¥å…·é“¾ï¼Œéµå¾ªå•ä¸€èŒè´£åŸåˆ™å’Œæ¥å£æ¸…æ™°çš„è®¾è®¡ç†å¿µã€‚

## æ ¸å¿ƒè®¾è®¡å“²å­¦

åŸºäºLinus Torvaldsçš„"å¥½å“å‘³"åŸåˆ™ï¼š
- **ç®€æ´èƒœè¿‡å¤æ‚**: æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µï¼Œä½¿ç”¨ç›´æ¥çš„æ•°æ®ç»“æ„å˜æ¢
- **å®ç”¨ä¸»ä¹‰ä¼˜å…ˆ**: è§£å†³çœŸå®é—®é¢˜ï¼ˆEventsä¸Voxelè½¬æ¢ï¼‰ï¼Œä¸è¿‡åº¦è®¾è®¡
- **æ¨¡å—åˆ†ç¦»**: encode.pyå’Œdecode.pyå®Œå…¨ç‹¬ç«‹ï¼Œå¯å•ç‹¬è°ƒç”¨å’Œæµ‹è¯•
- **å¯è§†åŒ–ç‹¬ç«‹**: professional_visualizer.pyä¸“é—¨å¤„ç†å¯è§†åŒ–ï¼ŒåŸºäºevent_utilsä¸“ä¸šå·¥å…·
- **ææ€§å¤„ç†å‡†åˆ™**: **1æ˜¯æ­£äº‹ä»¶ï¼Œé1éƒ½æ˜¯è´Ÿäº‹ä»¶** (é€šç”¨å¤„ç†å„ç§æ•°æ®æ ¼å¼)
- **æ—¶é—´ä¸€è‡´æ€§åŸåˆ™**: **å›ºå®šæ—¶é—´é—´éš”** (100ms/32bins) ç¡®ä¿è®­ç»ƒæµ‹è¯•æ³›åŒ–æ€§(æ­¤å¤„æ˜æ˜¾è¿‡æ—¶ï¼ï¼Œä¸ç¬¦åˆ100mså…ˆåˆ†æˆ5ä¸ª20ms)

## å…³é”®å·¥ç¨‹å†³ç­–ï¼šåˆ†æ®µå†…å­˜ä¼˜åŒ– + å›ºå®šæ—¶é—´é—´éš”
**é—®é¢˜**: 100mså¤§æ•°æ®å¯èƒ½å¯¼è‡´æ˜¾å­˜çˆ†ç‚¸

**è§£å†³æ–¹æ¡ˆ**: **åˆ†æ®µå†…å­˜ä¼˜åŒ– + å›ºå®šæ—¶é—´é—´éš”** - **2024-09-02å‡çº§**
- **åˆ†æ®µç­–ç•¥**: 100ms â†’ 5Ã—20msæ®µ (é¿å…æ˜¾å­˜çˆ†ç‚¸)
- **å¯è§†åŒ–é€‰æ‹©**: é»˜è®¤å¯è§†åŒ–ç¬¬2æ®µ (10-30msï¼Œsegment_idx=1)
- **å›ºå®šåˆ†è¾¨ç‡**: æ¯20msæ®µ â†’ 8ä¸ªbins (æ¯bin 2.5ms)
- **å†…å­˜ä¼˜åŒ–**: æ•°æ®é‡å‡å°‘åˆ°åŸæ¥çš„~21% (20ms vs 100ms)
- **è®­ç»ƒä¸€è‡´æ€§**: ä¿è¯æ‰€æœ‰æ ·æœ¬å…·æœ‰ç›¸åŒçš„æ—¶é—´è¯­ä¹‰

**å®ç°**: `events_to_voxel(fixed_duration_us=20000, num_bins=8)` (æ®µå†…)
```python
# åˆ†æ®µæå–: 100ms â†’ 5Ã—20ms
segment_duration_us = 100000 / 5  # 20ms per segment
# æ®µå†…ç¼–ç : 20ms â†’ 8 bins
dt = segment_duration_us / 8  # 2.5ms per bin
```

## ç¯å¢ƒé…ç½®

### Condaç¯å¢ƒ: Umain
- Python 3.8
- PyTorch 2.4.1 with CUDA 12.1ï¼ˆå…¼å®¹pytorch-3dunetï¼‰
- æ ¸å¿ƒä¾èµ–: numpy, h5py, matplotlib, opencv-python, scipy, pandas, pyyaml, scikit-image

### å…¼å®¹æ€§è¯´æ˜
- æ”¯æŒ3DUnetè®­ç»ƒç®¡é“ (pytorch-3dunet)
- GPU ready: CUDA 12.1
- æ ‡å‡†DVS/DSECæ ¼å¼å…¼å®¹

## é¡¹ç›®ç»“æ„ - **2025-01-02 3DUneté›†æˆå®Œæˆ**

```
.
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ data_processing/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ encode.py               # Events â†’ Voxel ç¼–ç å™¨
â”‚   â”‚   â”œâ”€â”€ decode.py               # Voxel â†’ Events è§£ç å™¨
â”‚   â”‚   â””â”€â”€ professional_visualizer.py  # ä¸“ä¸šå¯è§†åŒ–æ¨¡å—
â”‚   â”œâ”€â”€ datasets/                   # [æ–°] PyTorchæ•°æ®é›†
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ event_voxel_dataset.py  # EventVoxelDataset + InferenceDataset
â”‚   â”œâ”€â”€ models/                     # [æ–°] 3DUnetæ¨¡å‹å°è£…
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â””â”€â”€ utils/                      # [æ–°] å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ __init__.py  
â”‚       â””â”€â”€ config_loader.py        # ç»Ÿä¸€YAMLé…ç½®åŠ è½½å™¨
â”œâ”€â”€ config/
â”‚   â””â”€â”€ voxel_config.yaml           # åŸå§‹é…ç½®æ–‡ä»¶ (ç¼–è§£ç ç”¨)
â”œâ”€â”€ configs/                        # [æ–°] è®­ç»ƒé…ç½®ç³»ç»Ÿ
â”‚   â”œâ”€â”€ train_config.yaml           # è®­ç»ƒé…ç½®
â”‚   â”œâ”€â”€ test_config.yaml            # æµ‹è¯•é…ç½®
â”‚   â””â”€â”€ inference_config.yaml       # æ¨ç†é…ç½®
â”œâ”€â”€ main.py                         # [æ–°] é¡¹ç›®æ€»å…¥å£ (train/test/inference)
â”œâ”€â”€ debug_output/                   # Debugå¯è§†åŒ–è¾“å‡º
â”œâ”€â”€ event_utils-master/             # ç¬¬ä¸‰æ–¹å¯è§†åŒ–åº“
â”œâ”€â”€ testdata/
â”‚   â””â”€â”€ light_source_sequence_00018.h5
â””â”€â”€ format.txt                      # H5æ ¼å¼è¯´æ˜
```

## æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. ç¼–ç å™¨ (src/data_processing/encode.py)

**æ ¸å¿ƒèŒè´£**: Events â†’ Voxelè½¬æ¢

**æ•°æ®åŠ è½½å‡½æ•°**: `load_h5_events(file_path)`
- **è¾“å…¥**: H5æ–‡ä»¶è·¯å¾„
- **è¾“å‡º**: NumPyæ•°ç»„ (N, 4) [t, x, y, p]
- **ææ€§å‡†åˆ™**: **1â†’æ­£äº‹ä»¶(+1), é1â†’è´Ÿäº‹ä»¶(-1)** (é€šç”¨å¤„ç†)
- **å…¼å®¹æ€§**: æ”¯æŒ `{0,1}`, `{-1,1}`, `{0,1,2}` ç­‰å„ç§æ ¼å¼

**æ ¸å¿ƒå‡½æ•°**: `events_to_voxel(events_np, num_bins=32, sensor_size, fixed_duration_us=100000)`
- **è¾“å…¥**: NumPyæ•°ç»„ (N, 4) [t, x, y, p]  
- **è¾“å‡º**: PyTorchå¼ é‡ (B, H, W)
- **ç®—æ³•**: ç®€å•ç´¯ç§¯ï¼Œæ­£è´Ÿäº‹ä»¶åˆ†åˆ«å¤„ç†
- **å…³é”®ç‰¹æ€§**: **å›ºå®šæ—¶é—´é—´éš”** (100ms/32bins = 3.125ms/bin)
- **è®­ç»ƒä¸€è‡´æ€§**: ç¡®ä¿æ‰€æœ‰æ•°æ®é›†ä½¿ç”¨ç›¸åŒçš„æ—¶é—´åˆ†è¾¨ç‡ï¼Œé¿å…æ³›åŒ–æ€§é—®é¢˜

**ç‹¬ç«‹æ‰§è¡Œ**:
```bash
python src/data_processing/encode.py \
  --input_file testdata/light_source_sequence_00018.h5 \
  --output_voxel_file output.pt \
  --debug
```

### 2. è§£ç å™¨ (src/data_processing/decode.py)

**æ ¸å¿ƒèŒè´£**: Voxel â†’ Eventsè½¬æ¢

**æ ¸å¿ƒå‡½æ•°**: `voxel_to_events(voxel, total_duration, sensor_size)`
- **è¾“å…¥**: PyTorchå¼ é‡ (B, H, W)
- **è¾“å‡º**: NumPyæ•°ç»„ (N, 4) [t, x, y, p]
- **ç®—æ³•**: å‡åŒ€éšæœºåˆ†å¸ƒè§£ç ï¼ŒåŸºäºç‰©ç†æ„ä¹‰
- **æµç¨‹**: æµ®ç‚¹â†’æ•´æ•°â†’ç”Ÿæˆå¯¹åº”æ•°é‡äº‹ä»¶â†’éšæœºæ—¶é—´æˆ³

**ç‹¬ç«‹æ‰§è¡Œ**:
```bash
python src/data_processing/decode.py \
  --input_voxel_file input.pt \
  --output_file output.h5 \
  --debug
```

### 3. ä¸“ä¸šå¯è§†åŒ–æ¨¡å— (src/data_processing/professional_visualizer.py) - **2024-09-02æ›´æ–°**

**æ ¸å¿ƒèŒè´£**: åŸºäºevent_utilsçš„ä¸“ä¸šçº§Eventså’ŒVoxelå¯è§†åŒ–ç³»ç»Ÿ

**é‡æ„è®¾è®¡ç†å¿µ** (éµå¾ªLinus**"æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ"**åŸåˆ™):
- **"ç”¨å·²æœ‰çš„å¥½å·¥å…·"**: ç›´æ¥ä½¿ç”¨event_utils-masterï¼Œä¸é‡æ–°å‘æ˜è½®å­
- **å¹¿ä¹‰å¯è§†åŒ–**: æ”¯æŒä»»æ„ç¯èŠ‚ã€ä»»æ„é˜¶æ®µçš„eventså’Œvoxelæ•°æ®
- **å›ºå®šçª—å£**: **ç»Ÿä¸€100ms/32bins** - æ¶ˆé™¤å¤šå°ºåº¦å¤æ‚æ€§
- **åŒæ­¥å¯è§†åŒ–**: **åŒæ—¶è¾“å‡ºeventså’Œvoxel**å¯è§†åŒ–
- **é›¶ä¾èµ–å‡è®¾**: è‡ªåŠ¨å¤„ç†event_utilså¯¼å…¥å’Œå…¼å®¹æ€§

**æ ¸å¿ƒåŠŸèƒ½** - **2024-09-02å®Œæ•´6å¯è§†åŒ–æ¶æ„**:

## **å®Œæ•´6ä¸ªå¯è§†åŒ–ç»“æœ** (2Ã—2+2æ¶æ„):

### **Eventsæ•°æ®å¯è§†åŒ–** (è¾“å…¥+è¾“å‡º Ã— 3D+2D = 4ä¸ªç»“æœ):
1. **è¾“å…¥Events 3Dæ—¶ç©ºå¯è§†åŒ–**: 
   - åŸç”Ÿ3Dæ—¶ç©ºæ•£ç‚¹å›¾ + 8çª—å£3Dæ—¶é—´åºåˆ—
2. **è¾“å…¥Events 2Dçº¢è“æ—¶åºå¯è§†åŒ–**: 
   - **8å¼ 2Dæ—¶åºå›¾åƒ** (çº¢è“ææ€§æ˜¾ç¤ºï¼Œä¸3Dç›¸åŒæ—¶é—´é—´éš”)
3. **è¾“å‡ºEvents 3Dæ—¶ç©ºå¯è§†åŒ–**: 
   - åŸç”Ÿ3Dæ—¶ç©ºæ•£ç‚¹å›¾ + 8çª—å£3Dæ—¶é—´åºåˆ—  
4. **è¾“å‡ºEvents 2Dçº¢è“æ—¶åºå¯è§†åŒ–**: 
   - **8å¼ 2Dæ—¶åºå›¾åƒ** (çº¢è“ææ€§æ˜¾ç¤ºï¼Œä¸3Dç›¸åŒæ—¶é—´é—´éš”)

### **Voxelæ•°æ®å¯è§†åŒ–** (è¾“å…¥+è¾“å‡º = 2ä¸ªç»“æœ):
5. **è¾“å…¥Eventsâ†’Voxelå¯è§†åŒ–**: 
   - 32ä¸ªæ—¶é—´binå±•ç¤º + ç»Ÿè®¡åˆ†æå›¾
6. **è¾“å‡ºEventsâ†’Voxel(é‡ç¼–ç )å¯è§†åŒ–**: 
   - 32ä¸ªæ—¶é—´binå±•ç¤º + ç»Ÿè®¡åˆ†æå›¾

### **æ ¸å¿ƒç‰¹æ€§**:
- **æ—¶é—´é—´éš”ç»Ÿä¸€**: æ‰€æœ‰å¯è§†åŒ–ä½¿ç”¨**ç›¸åŒçš„å›ºå®šæ—¶é—´åˆ†å‰²** (100ms/8çª—å£)
- **çº¢è“ææ€§æ˜¾ç¤º**: 2Dæ—¶åºå›¾åƒä½¿ç”¨RdBu colormap (çº¢=æ­£äº‹ä»¶ï¼Œè“=è´Ÿäº‹ä»¶)
- **pipelineå¯¹æ¯”**: è¾“å…¥å’Œè¾“å‡ºeventsä½¿ç”¨å®Œå…¨ç›¸åŒçš„å¯è§†åŒ–å‚æ•°

**ä¸“ä¸šç‰¹æ€§**:
- **å›ºå®šå‚æ•°**: æ¶ˆé™¤å¤šå°ºåº¦é€‰æ‹©å¤æ‚æ€§ (å›ºå®š32bins)
- **event_utilsåŸç”Ÿé›†æˆ**: ä½¿ç”¨ä¸“ä¸šå¯è§†åŒ–å‡½æ•°
- **è‡ªåŠ¨é‡‡æ ·**: æ™ºèƒ½å¤„ç†å¤§æ•°æ®é›†ï¼Œé¿å…å†…å­˜é—®é¢˜
- **æ ¼å¼è‡ªé€‚åº”**: è‡ªåŠ¨è½¬æ¢æ•°æ®æ ¼å¼
- **é”™è¯¯å®¹å¿**: matplotlibå…¼å®¹æ€§é—®é¢˜è‡ªåŠ¨fallback

**ä½¿ç”¨æ¥å£** - **2024-09-02åˆ†æ®µå†…å­˜ä¼˜åŒ–**:
```python
# å®Œæ•´6ä¸ªå¯è§†åŒ–ç»“æœ (æ¨è) - åˆ†æ®µå†…å­˜ä¼˜åŒ–ç‰ˆæœ¬
from src.data_processing.professional_visualizer import visualize_complete_pipeline
visualize_complete_pipeline(
    input_events=input_events_np,    # åŸå§‹è¾“å…¥events (100ms)
    input_voxel=input_voxel_tensor,  # ç¼–ç åçš„voxel
    output_events=output_events_np,  # è§£ç å¾—åˆ°çš„events
    output_voxel=output_voxel_tensor, # é‡ç¼–ç çš„voxel
    sensor_size=(480, 640),
    output_dir="debug_output",       # ç»Ÿä¸€è¾“å‡ºç›®å½•
    segment_idx=1                    # å¯è§†åŒ–æ®µç´¢å¼•: 1=10-30ms
)

# åˆ†æ®µå‚æ•°è¯´æ˜:
# segment_idx=0: 0-20ms
# segment_idx=1: 10-30ms (é»˜è®¤)
# segment_idx=2: 20-40ms
# segment_idx=3: 30-50ms  
# segment_idx=4: 40-60ms

# å•ç‹¬åŠŸèƒ½æ¥å£ (å…¼å®¹æ€§ä¿æŒ)
from src.data_processing.professional_visualizer import visualize_events_and_voxel
visualize_events_and_voxel(events_np, voxel_tensor, sensor_size, "debug_output", "pipeline")
```

**æµ‹è¯•è„šæœ¬**:
```bash
# è¿è¡Œåˆ†æ®µå†…å­˜ä¼˜åŒ–çš„6å¯è§†åŒ–pipeline
python test_6_visualizations.py
```

**è¾“å‡ºç»“æœ** - **2024-09-02åˆ†æ®µå†…å­˜ä¼˜åŒ–æ¶æ„** (ç»Ÿä¸€ä¿å­˜è‡³ `debug_output/`):

### **å†…å­˜ä¼˜åŒ–ç»Ÿè®¡** (åŸºäºcomposed_00003_bg_flare.h5):
- **åŸå§‹æ•°æ®**: 956,728 events (100ms)
- **åˆ†æ®µæ•°æ®**: 200,949 input + 172,774 output events (20msæ®µ)
- **å†…å­˜ä¼˜åŒ–**: æ•°æ®é‡å‡å°‘åˆ°åŸæ¥çš„~21%
- **æ˜¾å­˜å‹å¥½**: é¿å…100mså¤§æ•°æ®å¯¼è‡´çš„æ˜¾å­˜çˆ†ç‚¸

### **è¯¦ç»†æ–‡ä»¶ç»“æ„** (Segment 1: 10-30ms):

**1. è¾“å…¥Events 3D (Segment 1)**:
- `input_events_seg1_native_3d_spatiotemporal.png`: 20msæ®µ3Dæ—¶ç©ºæ•£ç‚¹å›¾
- `input_events_seg1_3d_series/`: 2å¼ 3Dæ—¶é—´çª—å£ (20msæ®µå†…)

**2. è¾“å…¥Events 2Dçº¢è“ (Segment 1)**:
- `input_events_seg1_2d_temporal/`: **2å¼ 2Dçº¢è“æ—¶åºå›¾** (20msæ®µå†…)

**3. è¾“å…¥Eventsâ†’Voxel (Segment 1)**:
- `input_voxel_seg1_temporal_bins.png`: 8ä¸ªæ—¶é—´binå¯è§†åŒ– (20msâ†’8bins)
- `input_voxel_seg1_analysis.png`: ç»Ÿè®¡åˆ†æå›¾

**4. è¾“å‡ºEvents 3D (Segment 1)**:
- `output_events_seg1_native_3d_spatiotemporal.png`: 20msæ®µ3Dæ—¶ç©ºæ•£ç‚¹å›¾  
- `output_events_seg1_3d_series/`: 2å¼ 3Dæ—¶é—´çª—å£

**5. è¾“å‡ºEvents 2Dçº¢è“ (Segment 1)**:
- `output_events_seg1_2d_temporal/`: **2å¼ 2Dçº¢è“æ—¶åºå›¾** (ç›¸åŒæ—¶é—´é—´éš”)

**6. è¾“å‡ºEventsâ†’Voxel (Segment 1)**:
- `output_voxel_seg1_temporal_bins.png`: 8ä¸ªæ—¶é—´binå¯è§†åŒ–
- `output_voxel_seg1_analysis.png`: ç»Ÿè®¡åˆ†æå›¾

**ä¼˜åŒ–ç‰¹æ€§**: 
- **å†…å­˜å‹å¥½**: 20msæ®µ vs 100mså…¨é‡ï¼Œæ˜¾å­˜å ç”¨å¤§å¹…é™ä½
- **æ—¶é—´ä¸€è‡´æ€§**: è¾“å…¥å’Œè¾“å‡ºä½¿ç”¨ç›¸åŒçš„20msæ—¶é—´æ®µ (10-30ms)
- **åˆ†è¾¨ç‡ä¿æŒ**: æ¯20msæ®µä»æœ‰8ä¸ªæ—¶é—´bins (2.5ms/bin)

### 4. é…ç½®ç³»ç»Ÿ (config/voxel_config.yaml)

**é»˜è®¤é…ç½®** (å·²ä¼˜åŒ–):
- **æ—¶é—´å‚æ•°**: **100mså›ºå®šè¾“å…¥ï¼Œ32ä¸ªæ—¶é—´bin** (3.125ms/bin)
- **å›ºå®šé—´éš”**: ç¡®ä¿è®­ç»ƒ/æµ‹è¯•ä¸€è‡´æ€§ï¼Œé¿å…æ³›åŒ–é—®é¢˜  
- **ä¿¡æ¯ä¿ç•™**: 87.6% (vs 16binsçš„50.5%)
- ä¼ æ„Ÿå™¨: 640Ã—480 (DSECæ ‡å‡†)
- ç¼–ç : ç®€å•ç´¯ç§¯ç®—æ³•
- è§£ç : å‡åŒ€éšæœºåˆ†å¸ƒ

## éªŒè¯ç»“æœ - **2024-09-02æ›´æ–°**

### ç«¯åˆ°ç«¯æµ‹è¯•æµç¨‹ (æ–°æµ‹è¯•æ–‡ä»¶)
1. **åŸå§‹æ•°æ®**: `testdata/composed_00003_bg_flare.h5` (956,728äº‹ä»¶)
2. **ç¬¬ä¸€æ¬¡ç¼–ç **: Events â†’ Voxel (32Ã—480Ã—640) - **å›ºå®š100ms/32bins**
3. **è§£ç **: Voxel â†’ Events (638,072äº‹ä»¶)  
4. **ç¬¬äºŒæ¬¡ç¼–ç **: Events â†’ Voxel (32Ã—480Ã—640)

### å…³é”®å‘ç° (å®Œç¾ä¸€è‡´æ€§éªŒè¯)
- **å®Œç¾ä¸€è‡´æ€§**: ä¸¤æ¬¡ç¼–ç çš„voxel**å®Œå…¨ç›¸åŒ** (L1=0.000000, L2=0.000000, Max=0.000000)
- **ä¿¡æ¯ä¿æŒ**: åŸå§‹voxel sum = 93,938ï¼Œé‡ç¼–ç voxel sum = 93,938 (å®Œå…¨åŒ¹é…)
- **å½¢çŠ¶ä¸€è‡´**: æ‰€æœ‰å¼ é‡å½¢çŠ¶å®Œå…¨ç›¸åŒ (32Ã—480Ã—640)
- **æ—¶é—´åˆ†å¸ƒ**: è§£ç æ—¶éšæœºæ—¶é—´æˆ³ä»è½åœ¨æ­£ç¡®çš„æ—¶é—´binå†…
- **ææ€§ä¿æŒ**: æ­£è´Ÿäº‹ä»¶æ¯”ä¾‹åœ¨ç¼–è§£ç ä¸­ä¿æŒä¸€è‡´

### å…¨æ–¹ä½å¯è§†åŒ–éªŒè¯ - **2024-09-02åˆ†æ®µå†…å­˜ä¼˜åŒ–æ¶æ„**
- **å®Œæ•´6ä¸ªå¯è§†åŒ–ç»“æœ**: è¾“å…¥events(3D+2D) + è¾“å‡ºevents(3D+2D) + è¾“å…¥voxel + è¾“å‡ºvoxel
- **å†…å­˜ä¼˜åŒ–**: 100ms â†’ 20msæ®µï¼Œæ•°æ®é‡å‡å°‘åˆ°21%ï¼Œé¿å…æ˜¾å­˜çˆ†ç‚¸
- **4å¼ 2Dçº¢è“æ—¶åºå›¾**: **è¾“å…¥å’Œè¾“å‡ºeventsçš„çº¢è“ææ€§å¯¹æ¯”** (å„2å¼ ï¼Œ20msæ®µå†…)
- **4ä¸ªåŸç”Ÿ3Dæ—¶ç©ºçª—å£**: è¾“å…¥å’Œè¾“å‡ºeventså„2ä¸ª3Dæ—¶é—´çª—å£ (20msæ®µå†…)
- **2ä¸ªåŸç”Ÿ3Dæ—¶ç©ºæ•´ä½“å›¾**: è¾“å…¥å’Œè¾“å‡ºeventsçš„20msæ®µ3Dæ—¶ç©ºæ•£ç‚¹å›¾
- **4ä¸ªvoxelåˆ†æå›¾**: è¾“å…¥å’Œè¾“å‡ºvoxelçš„8ä¸ªæ—¶é—´bin + ç»Ÿè®¡åˆ†æ
- **ä¸“ä¸šå·¥å…·**: ä½¿ç”¨event_utilsçš„`plot_events`å’Œ`events_to_image`å‡½æ•°
- **æ—¶é—´é—´éš”ç»Ÿä¸€**: **æ‰€æœ‰å¯è§†åŒ–ä½¿ç”¨ç›¸åŒçš„å›ºå®šæ—¶é—´åˆ†å‰²** (20ms/8bins)
- **pipelineå¯¹æ¯”**: è¾“å…¥â†’è¾“å‡ºçš„Segment 1 (10-30ms) å¯è§†åŒ–å¯¹æ¯”åˆ†æ
- **æ˜¾å­˜å‹å¥½**: é¿å…100mså¤§æ•°æ®å¤„ç†ï¼Œé€‚åˆGPUè®­ç»ƒç¯å¢ƒ

### Bugä¿®å¤è®°å½•
- âœ… ä¿®å¤encoder.pyå’Œdecode.pyä¸­çš„`debug_visualizer`å¯¼å…¥é”™è¯¯
- âœ… æ¶ˆé™¤professional_visualizerä¸­çš„å¤šå°ºåº¦å¤æ‚æ€§
- âœ… ç»Ÿä¸€ä¸ºå›ºå®š32binså¯è§†åŒ–çª—å£
- âœ… ä¿®å¤PyTorch `weights_only=True` è­¦å‘Š
- âœ… æ–°å¢`visualize_events_and_voxel()` ç»Ÿä¸€æ¥å£
- âœ… **æ–°å¢åŸç”Ÿevents 3Dæ—¶ç©ºå¯è§†åŒ–** (ä½¿ç”¨event_utils plot_events)
- âœ… **æ–°å¢å›ºå®šæ—¶é—´é—´éš”çš„3Dçª—å£åºåˆ—** (8çª—å£ Ã— 2.5msï¼Œ20msæ®µå†…)
- âœ… **æ–°å¢2Dçº¢è“æ—¶åºå¯è§†åŒ–** (ä½¿ç”¨event_utils events_to_image)
- âœ… **å®ç°å®Œæ•´6å¯è§†åŒ–æ¶æ„** (2Ã—2+2: è¾“å…¥/è¾“å‡ºeventsçš„3D+2D + è¾“å…¥/è¾“å‡ºvoxel)
- âœ… **åˆ†æ®µå†…å­˜ä¼˜åŒ–** (100ms â†’ 5Ã—20msï¼Œé€‰æ‹©10-30msæ®µå¯è§†åŒ–)
- âœ… **ç»Ÿä¸€è¾“å‡ºç›®å½•** (æ‰€æœ‰å¯è§†åŒ–ç»Ÿä¸€ä¿å­˜è‡³debug_output)
- âœ… **ä¿®å¤æ—¶é—´çª—å£è®¡ç®—** (20msæ®µå†…æ­£ç¡®åˆ†ä¸º8ä»½ï¼Œæ¯ä»½2.5ms)

## æŠ€æœ¯çªç ´

### 1. ç®€åŒ–å®ç°
æ”¾å¼ƒäº†æœ‰bugçš„event_utils voxelå‡½æ•°ï¼Œè‡ªå®ç°ç®€æ´ç‰ˆæœ¬ï¼š
- ç›´æ¥çš„æ—¶é—´åˆ†binç®—æ³•
- ç®€å•çš„è¾¹ç•Œæ£€æŸ¥
- æ¸…æ™°çš„æ•°ç»„æ“ä½œï¼Œæ— ç‰¹æ®Šæƒ…å†µ

### 2. æ¨¡å—ç‹¬ç«‹æ€§
- æ¯ä¸ªæ¨¡å—å¯ç‹¬ç«‹å¯¼å…¥å’Œè°ƒç”¨
- æ¸…æ™°çš„å‡½æ•°æ¥å£ï¼Œéšè—å®ç°ç»†èŠ‚
- ç‹¬ç«‹çš„å‘½ä»¤è¡Œå·¥å…·å’Œdebugæ¨¡å¼

### 3. ä¸“ä¸šå¯è§†åŒ–
- **EventsVoxelVisualizerç±»**: å°è£…æ‰€æœ‰å¯è§†åŒ–åŠŸèƒ½
- **ä¸°å¯Œåˆ†æ**: 100msæ•°æ®ç”Ÿæˆ10+å¼ ä¸“ä¸šåˆ†æå›¾
- **event_utilsé›†æˆ**: ä¼˜å…ˆä½¿ç”¨ä¸“ä¸šåº“ï¼Œæœ‰fallbackä¿è¯

### 4. é…ç½®é©±åŠ¨
- YAMLé…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç†å‚æ•°
- å‘½ä»¤è¡Œå‚æ•°å¯è¦†ç›–é…ç½®
- ä¾¿äºåç»­è®­ç»ƒé›†æˆ

## åç»­é›†æˆè®¡åˆ’

### 3DUnetè®­ç»ƒé›†æˆ
- ç¼–ç å™¨å¯ç›´æ¥ä¸ºè®­ç»ƒæä¾›Voxelè¾“å…¥
- è§£ç å™¨å¯ç”¨äºç”Ÿæˆsynthetic data
- GPUåŠ é€Ÿready

### æ•°æ®å¤„ç†ç®¡é“
```python
# è®­ç»ƒæ—¶ä½¿ç”¨ (ç»Ÿä¸€32bins)
from src.data_processing.encode import events_to_voxel
voxel = events_to_voxel(events, num_bins=32, sensor_size=(480,640))

# æ¨ç†åä½¿ç”¨
from src.data_processing.decode import voxel_to_events  
events = voxel_to_events(voxel, total_duration=100000)

# ç»Ÿä¸€å¯è§†åŒ–æ¥å£ (æ¨è)
from src.data_processing.professional_visualizer import visualize_events_and_voxel
# åŒæ—¶å¯è§†åŒ–eventså’Œvoxelï¼Œå›ºå®š32bins
visualize_events_and_voxel(events, voxel, sensor_size, "debug_output", "training_batch_01")

# å•ç‹¬å¯è§†åŒ– (å›ºå®šå‚æ•°)
from src.data_processing.professional_visualizer import visualize_events, visualize_voxel
visualize_events(events, sensor_size, "debug_output", "events_only", 32)  # å›ºå®š32åˆ‡ç‰‡
visualize_voxel(voxel, sensor_size, "debug_output", "voxel_only", 100)    # å›ºå®š100ms
```

## æ€»ç»“ - **2024-09-02æ›´æ–°**

å®ç°äº†ä¸€ä¸ªéµå¾ªLinus **"å¥½å“å‘³"** åŸåˆ™çš„è§£å†³æ–¹æ¡ˆï¼š

### æ ¸å¿ƒè®¾è®¡ä¼˜åŠ¿
- **æ•°æ®ç»“æ„æ­£ç¡®**: Events (N,4) â†” Voxel (32,H,W)ï¼Œç›´æ¥å¯¹åº”
- **æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ**: ç»Ÿä¸€å›ºå®š100ms/32binsï¼Œæ— å¤šå°ºåº¦å¤æ‚æ€§
- **å®ç”¨æ€§éªŒè¯**: ç«¯åˆ°ç«¯æµ‹è¯•è¯æ˜å®Œå…¨å¯ç”¨ (L1=L2=0.000000)
- **æ¥å£ç®€æ´**: å‡½æ•°èŒè´£å•ä¸€ï¼Œ`visualize_events_and_voxel()` ä¸€ç«™å¼è°ƒç”¨
- **å¯è§†åŒ–ç»Ÿä¸€**: åŒæ—¶è¾“å‡ºeventså’Œvoxelï¼Œ72å¼ ä¸“ä¸šåˆ†æå›¾

### Linuså¼å·¥ç¨‹å®è·µ
- **"Never break userspace"**: å‘åå…¼å®¹ï¼Œæ‰€æœ‰ç°æœ‰æ¥å£ä¿æŒå¯ç”¨
- **"æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ"**: ä»å¤šå°ºåº¦(8,16,32)ç®€åŒ–ä¸ºå›ºå®š32bins
- **"ç”¨å·²æœ‰å¥½å·¥å…·"**: ç›´æ¥ä½¿ç”¨event_utilsä¸“ä¸šåº“ï¼Œé¿å…é‡å¤é€ è½®å­
- **"å®ç”¨ä¸»ä¹‰"**: è§£å†³çœŸå®é—®é¢˜ï¼ˆevents-voxelè½¬æ¢ï¼‰ï¼Œä¸è¿½æ±‚ç†è®ºå®Œç¾

### æµ‹è¯•éªŒè¯å®Œæ•´æ€§ - **2024-09-02å‡çº§**
- **å®Œç¾ä¸€è‡´æ€§**: ç¼–è§£ç pipelineæ•°å­¦ä¸Šå®Œå…¨å¯é€†
- **å¤§è§„æ¨¡éªŒè¯**: 956K+äº‹ä»¶çš„çœŸå®æ•°æ®æµ‹è¯•
- **3Då¯è§†åŒ–é©æ–°**: **è¾“å…¥eventsåŸç”Ÿ3D + è¾“å‡ºeventsåŸç”Ÿ3D + voxelå…¨æ–¹ä½å¯è§†åŒ–**
- **æ—¶é—´é—´éš”ç»Ÿä¸€**: è¾“å…¥å’Œè¾“å‡ºä½¿ç”¨**ç›¸åŒçš„å›ºå®šæ—¶é—´åˆ†å‰²**ï¼Œä¾¿äºpipelineå¯¹æ¯”
- **Bugé›¶æ®‹ç•™**: æ‰€æœ‰å¯¼å…¥é”™è¯¯ã€PyTorchè­¦å‘Šã€å¤šå°ºåº¦å¤æ‚æ€§å…¨éƒ¨ä¿®å¤

è¿™ä¸æ˜¯ç†è®ºä¸Šçš„å®Œç¾ï¼Œè€Œæ˜¯**å·¥ç¨‹ä¸Šçš„å®ç”¨å’Œç®€æ´**ã€‚éµå¾ªLinusçš„æ ¸å¿ƒå“²å­¦ï¼š**å¥½çš„ä»£ç è®©ç‰¹æ®Šæƒ…å†µæ¶ˆå¤±ï¼Œå˜æˆæ­£å¸¸æƒ…å†µ**ã€‚

## å¯è§†åŒ–æµ‹è¯•éªŒè¯

**å®Œæ•´ç®¡é“æµ‹è¯•æˆåŠŸ** (`test_professional_viz.py`):
- âœ… åŸå§‹events: 1,767,723ä¸ªäº‹ä»¶ â†’ 32å¼ æ—¶é—´åˆ‡ç‰‡ + 3Dæ—¶ç©ºå›¾ + æ»‘çª—è§†é¢‘(25å¸§)
- âœ… Voxelç¼–ç : (16Ã—480Ã—640) â†’ 16ä¸ªæ—¶é—´bin + ç»Ÿè®¡åˆ†æå›¾
- âœ… Eventsè§£ç : 929,956ä¸ªäº‹ä»¶ â†’ 32å¼ æ—¶é—´åˆ‡ç‰‡ + å¯¹æ¯”åˆ†æ
- âœ… ç«¯åˆ°ç«¯ä¸€è‡´æ€§: L1è¯¯å·®=0.000002, L2è¯¯å·®=0.001426 (è¿‘ä¹å®Œç¾)

**ç”Ÿæˆå†…å®¹**: æ€»è®¡134ä¸ªå¯è§†åŒ–æ–‡ä»¶ï¼ŒåŒ…æ‹¬æ—¶é—´åˆ‡ç‰‡ã€3Då›¾ã€ç»Ÿè®¡åˆ†æã€æ»‘çª—è§†é¢‘ç­‰ä¸“ä¸šçº§å¯è§†åŒ–è¾“å‡ºã€‚

**ææ€§é—®é¢˜ä¿®å¤**: å‘ç°å¹¶ä¿®å¤äº†H5æ•°æ® `{0,1}` æ ¼å¼å¯¼è‡´çš„å•è‰²æ˜¾ç¤ºé—®é¢˜ï¼Œç°åœ¨æ­£ç¡®æ˜¾ç¤ºçº¢è“åŒè‰²ææ€§å¯è§†åŒ–ã€‚

# 3DUnetè®­ç»ƒç®¡é“é›†æˆ - **2025-01-02å®Œæˆ** - **ç‚«å…‰å»é™¤(Deflare)**

## æ ¸å¿ƒæ¶æ„è®¾è®¡ - ç‚«å…‰å»é™¤ä»»åŠ¡

åŸºäºpytorch-3dunetæ¡†æ¶çš„å®Œæ•´**äº‹ä»¶ç‚«å…‰å»é™¤(Event Deflare)**è®­ç»ƒä¸æ¨ç†ç³»ç»Ÿï¼Œéµå¾ª**"å…³æ³¨ç‚¹åˆ†ç¦»"**åŸåˆ™ï¼š

**é‡è¦æ›´æ­£**: 
- **ä»»åŠ¡æ€§è´¨**: **ç‚«å…‰å»é™¤(Deflare)** - ä¸æ˜¯å»å™ª(Denoising)
- **æ•°æ®è·¯å¾„**: `E:/2025/event_flick_flare/main/output/data_simu/physics_method/`
- **è¾“å…¥æ–‡ä»¶å¤¹**: `background_with_flare_events/` (å«ç‚«å…‰çš„èƒŒæ™¯äº‹ä»¶H5æ–‡ä»¶)
- **ç›®æ ‡æ–‡ä»¶å¤¹**: `background_with_light_events/` (ä»…æœ‰å…‰æºå’ŒèƒŒæ™¯çš„å¹²å‡€äº‹ä»¶H5æ–‡ä»¶)
- **è®­ç»ƒç›®æ ‡**: å­¦ä¹ ä»å«ç‚«å…‰äº‹ä»¶ä¸­å»é™¤ç‚«å…‰ï¼Œä¿ç•™çœŸå®çš„èƒŒæ™¯å’Œå…‰æºäº‹ä»¶
- **æ–‡ä»¶å‘½å**: åŸæœ¬çš„åŒ¹é…æ–¹å¼æ˜¯æ­£ç¡®çš„ï¼Œä¸éœ€è¦ä¿®æ”¹

### æ•°æ®æµæ¶æ„
```
H5 Events (100ms) 
    â†“ (åˆ†æ®µç­–ç•¥)
5Ã—20ms Segments 
    â†“ (EventVoxelDataset)
Voxel (1,8,480,640) 
    â†“ (pytorch-3dunet)
Denoised Voxel (1,8,480,640)
    â†“ (è§£ç é‡å»º)
Denoised Events â†’ H5
```

### å…³é”®è®¾è®¡å†³ç­–

**1. åˆ†æ®µå†…å­˜ä¼˜åŒ–**
- **é—®é¢˜**: 100mså¤§æ•°æ®å¯¼è‡´æ˜¾å­˜çˆ†ç‚¸
- **è§£å†³**: 100ms â†’ 5Ã—20msæ®µï¼Œæ¯æ®µç‹¬ç«‹å¤„ç†
- **æ•ˆæœ**: æ˜¾å­˜å ç”¨å‡å°‘80%ï¼Œè®­ç»ƒç¨³å®šæ€§å¤§å¹…æå‡

**2. å›ºå®šæ—¶é—´åˆ†è¾¨ç‡**
- **ä¸€è‡´æ€§ä¿è¯**: æ‰€æœ‰æ ·æœ¬ç»Ÿä¸€20ms/8bins = 2.5ms/bin
- **æ³›åŒ–æ€§**: è®­ç»ƒå’Œæ¨ç†ä½¿ç”¨ç›¸åŒçš„æ—¶é—´è¯­ä¹‰
- **pytorch-3dunetå…¼å®¹**: (1, 8, 480, 640) æ ‡å‡†4Då¼ é‡

**3. æ¨¡å—åŒ–è®¾è®¡**
- **æ•°æ®é›†**: EventVoxelDataset (è®­ç»ƒ) + EventVoxelInferenceDataset (æ¨ç†)
- **é…ç½®**: ç»Ÿä¸€YAMLé…ç½®ç³»ç»Ÿ (train/test/inferenceä¸‰ç§æ¨¡å¼)
- **å…¥å£**: main.pyå•ä¸€å…¥å£ï¼Œæ”¯æŒå®Œæ•´MLOpsæµç¨‹

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. EventVoxelDataset (src/datasets/event_voxel_dataset.py)

**èŒè´£**: è¿æ¥äº‹ä»¶æ•°æ®ä¸pytorch-3dunetè®­ç»ƒæ¡†æ¶

**ç‰¹æ€§**:
- **é…å¯¹æ•°æ®**: è‡ªåŠ¨æ‰«æå’ŒåŒ¹é…noisy/cleanäº‹ä»¶æ–‡ä»¶å¯¹
- **åˆ†æ®µå¤„ç†**: æ¯ä¸ª100msæ–‡ä»¶äº§ç”Ÿ5ä¸ªè®­ç»ƒæ ·æœ¬
- **æ ¼å¼è½¬æ¢**: Events â†’ Voxel â†’ (1,8,H,W) pytorch-3dunetæ ¼å¼
- **å†…å­˜å‹å¥½**: 20msæ®µå¤„ç†ï¼Œé¿å…å¤§æ•°æ®æ˜¾å­˜é—®é¢˜

**ä½¿ç”¨**:
```python
from src.datasets.event_voxel_dataset import EventVoxelDataset

dataset = EventVoxelDataset(
    noisy_events_dir="/path/to/noisy_events",
    clean_events_dir="/path/to/clean_events",
    sensor_size=(480, 640),
    segment_duration_us=20000,  # 20ms
    num_bins=8                  # 8 temporal bins
)

# è¿”å›: {'raw': (1,8,480,640), 'label': (1,8,480,640)}
```

### 2. é…ç½®ç³»ç»Ÿ (src/utils/config_loader.py + configs/*.yaml)

**ä¸‰å¥—é…ç½®æ–‡ä»¶**:

**è®­ç»ƒé…ç½® (configs/train_config.yaml)**:
- æ•°æ®åŠ è½½å™¨: EventVoxelDataseté…ç½®
- æ¨¡å‹æ¶æ„: UNet3Då‚æ•°
- è®­ç»ƒè¿‡ç¨‹: epochs, å­¦ä¹ ç‡, ä¼˜åŒ–å™¨
- æŸå¤±å‡½æ•°: MSELoss (å›å½’ä»»åŠ¡)

**æµ‹è¯•é…ç½® (configs/test_config.yaml)**:
- è¯„ä¼°æŒ‡æ ‡: MSE, PSNR, MAE
- é¢„æµ‹å™¨é…ç½®: StandardPredictor
- è¾“å‡ºè®¾ç½®: ç»“æœä¿å­˜æ ¼å¼

**æ¨ç†é…ç½® (configs/inference_config.yaml)**:
- æ¨¡å‹è·¯å¾„: è®­ç»ƒå¥½çš„checkpoint
- å¤„ç†å‚æ•°: åˆ†æ®µé…ç½®, è®¾å¤‡é€‰æ‹©
- é‡å»ºè®¾ç½®: voxelâ†’eventsè§£ç å‚æ•°

### 3. ä¸»å…¥å£ (main.py)

**ä¸‰ç§è¿è¡Œæ¨¡å¼**:

**è®­ç»ƒæ¨¡å¼**:
```bash
python main.py train --config configs/train_config.yaml
# å†…éƒ¨è°ƒç”¨: train3dunet --config configs/train_config.yaml
```

**æµ‹è¯•æ¨¡å¼**:
```bash
python main.py test --config configs/test_config.yaml
# å†…éƒ¨è°ƒç”¨: predict3dunet --config configs/test_config.yaml
```

**æ¨ç†æ¨¡å¼ (è‡ªå®šä¹‰å®ç°)**:
```bash
python main.py inference --config configs/inference_config.yaml \
  --input noisy_events.h5 --output denoised_events.h5
```

**æ¨ç†æµç¨‹**:
1. åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹
2. åˆ†æ®µå¤„ç†è¾“å…¥äº‹ä»¶ (100ms â†’ 5Ã—20ms)
3. æ¯æ®µç¼–ç ä¸ºvoxel â†’ æ¨¡å‹æ¨ç† â†’ è§£ç ä¸ºäº‹ä»¶
4. åˆå¹¶æ‰€æœ‰æ®µäº‹ä»¶ â†’ ä¿å­˜H5æ–‡ä»¶

## å·¥ç¨‹å®è·µäº®ç‚¹

### Linuså¼"å¥½å“å‘³"å®ç°

**1. æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ**
- ç»Ÿä¸€20ms/8binsï¼Œæ— å¤šå°ºåº¦å¤æ‚æ€§
- å›ºå®šæ•°æ®æ ¼å¼ï¼š(1,8,480,640)ï¼Œæ— ç»´åº¦å˜åŒ–
- æ ‡å‡†pytorch-3dunetæ¥å£ï¼Œæ— è‡ªå®šä¹‰è®­ç»ƒå¾ªç¯

**2. æ•°æ®ç»“æ„æ­£ç¡®**
- Events (N,4) â†’ Voxel (8,H,W) â†’ Model (1,8,H,W)ï¼Œç›´æ¥å¯¹åº”
- åˆ†æ®µç­–ç•¥è‡ªç„¶æ˜ å°„åˆ°è®­ç»ƒæ ·æœ¬ï¼Œæ— é¢å¤–å¤æ‚æ€§
- YAMLé…ç½®é©±åŠ¨ï¼Œå‚æ•°ç®¡ç†æ¸…æ™°

**3. å®ç”¨ä¸»ä¹‰**
- ç›´æ¥åˆ©ç”¨pytorch-3dunetæˆç†Ÿæ¡†æ¶ï¼Œé¿å…é‡å¤é€ è½®å­
- åˆ†æ®µå†…å­˜ä¼˜åŒ–è§£å†³å®é™…æ˜¾å­˜é™åˆ¶é—®é¢˜
- ç«¯åˆ°ç«¯pipelineå¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒ

### å…¼å®¹æ€§è®¾è®¡

**å‘åå…¼å®¹**:
- æ‰€æœ‰åŸæœ‰ç¼–è§£ç æ¥å£ä¿æŒä¸å˜
- professional_visualizer.pyå®Œå…¨å…¼å®¹
- ç°æœ‰æµ‹è¯•è„šæœ¬æ— éœ€ä¿®æ”¹

**å‰å‘æ‰©å±•**:
- æ”¯æŒä¸åŒpytorch-3dunetæ¨¡å‹ (UNet3D, ResidualUNet3D)
- æ”¯æŒå¤šç§æŸå¤±å‡½æ•° (MSE, L1, SmoothL1)
- é…ç½®ç³»ç»Ÿå¯è½»æ¾æ·»åŠ æ–°å‚æ•°

## æ€§èƒ½ç‰¹å¾

### å†…å­˜ä¼˜åŒ–æ•ˆæœ
- **åŸæ–¹æ¡ˆ**: 100mså…¨é‡å¤„ç†ï¼Œæ˜¾å­˜å ç”¨é«˜
- **æ–°æ–¹æ¡ˆ**: 20msåˆ†æ®µå¤„ç†ï¼Œæ˜¾å­˜å ç”¨é™ä½80%
- **è®­ç»ƒç¨³å®šæ€§**: å¤§å¹…å‡å°‘OOMé”™è¯¯

### æ—¶é—´ä¸€è‡´æ€§ä¿è¯
- **è®­ç»ƒ**: æ‰€æœ‰æ ·æœ¬20ms/8bins = 2.5ms/bin
- **æ¨ç†**: ç›¸åŒæ—¶é—´åˆ†è¾¨ç‡ï¼Œç¡®ä¿æ³›åŒ–æ€§
- **è¯„ä¼°**: æ—¶é—´ç‰¹å¾ä¸€è‡´ï¼ŒæŒ‡æ ‡å¯æ¯”è¾ƒ

### æ•°æ®åˆ©ç”¨ç‡
- **æ ·æœ¬æ‰©å¢**: æ¯ä¸ª100msæ–‡ä»¶ â†’ 5ä¸ªè®­ç»ƒæ ·æœ¬
- **æ•°æ®å¤šæ ·æ€§**: ä¸åŒæ—¶é—´æ®µç‰¹å¾äº’è¡¥
- **è®­ç»ƒæ•ˆç‡**: æ›´å¤šæ ·æœ¬ï¼Œæ›´å¥½æ³›åŒ–

## åç»­ä¼˜åŒ–æ–¹å‘

### æ¨¡å‹æ¶æ„æ¢ç´¢
- **ResidualUNet3D**: æ›´æ·±ç½‘ç»œï¼Œå¯èƒ½æ›´å¥½çš„å»å™ªæ•ˆæœ
- **æŸå¤±å‡½æ•°**: å®éªŒSSIM, Perceptual Lossç­‰
- **å¤šå°ºåº¦**: æ¢ç´¢ä¸åŒæ—¶é—´åˆ†è¾¨ç‡çš„ç»„åˆ

### æ•°æ®å¢å¼º
- **ç©ºé—´å˜æ¢**: æ—‹è½¬ã€ç¿»è½¬ã€è£å‰ª
- **æ—¶é—´å¢å¼º**: æ—¶é—´åè½¬ã€é€Ÿåº¦è°ƒæ•´
- **å™ªå£°æ³¨å…¥**: æ¨¡æ‹Ÿä¸åŒå™ªå£°ç±»å‹

### ç”Ÿäº§éƒ¨ç½²
- **æ¨¡å‹å‹ç¼©**: é‡åŒ–ã€å‰ªæä¼˜åŒ–
- **æ‰¹å¤„ç†**: å¤šæ–‡ä»¶å¹¶è¡Œå¤„ç†
- **ç›‘æ§ç³»ç»Ÿ**: è®­ç»ƒè¿‡ç¨‹å¯è§‚æµ‹æ€§

## å½“å‰çŠ¶å†µè®°å½• - **2025-01-03è°ƒè¯•é˜¶æ®µ**

### æˆåŠŸé›†æˆæƒ…å†µ
âœ… **æ•°æ®é›†æˆåŠŸè¯†åˆ«**: 500ä¸ªH5æ–‡ä»¶å¯¹æ­£ç¡®åŒ¹é… (background_with_flare_events â†” background_with_light_events)
âœ… **è®­ç»ƒæ ·æœ¬ç”Ÿæˆ**: 2500ä¸ªè®­ç»ƒæ ·æœ¬ (æ¯ä¸ª100msæ–‡ä»¶â†’5ä¸ª20msæ®µ)  
âœ… **UNet3Dæ¨¡å‹åˆ›å»º**: pytorch-3dunetæ¨¡å‹æˆåŠŸåŠ è½½ (13,183å‚æ•°)
âœ… **è‡ªå®šä¹‰è®­ç»ƒå¾ªç¯**: å®Œå…¨æ‘†è„±pytorch-3dunetæ¡†æ¶ï¼Œåªä½¿ç”¨å…¶UNet3Dæ¨¡å‹
âœ… **æ•°æ®æµé…ç½®**: 20ms/8bins = 2.5ms per bin (æ­£ç¡®çš„åˆ†æ®µç­–ç•¥)

### è§£å†³çš„é—®é¢˜å’Œå½“å‰çŠ¶æ€
âœ… **GPUç¯å¢ƒæˆåŠŸé…ç½®**: åˆ é™¤mambaï¼Œç”¨condaå‡çº§åˆ°PyTorch 2.3.0 + CUDA 12.1 + pytorch-3dunet
âœ… **æ•°æ®è¯»å–éªŒè¯é€šè¿‡**: ç¡®è®¤è¯»å–physics_methodæ•°æ® (500ä¸ªæ–‡ä»¶å¯¹ï¼Œ956Kâ†’436Käº‹ä»¶)
âœ… **GPUè®­ç»ƒæˆåŠŸ**: ä½¿ç”¨æå°æ¨¡å‹å‚æ•° ([4,8] feature maps, 3,353å‚æ•°) åœ¨RTX 4060ä¸Šè®­ç»ƒ
âœ… **æ¨¡å‹å‚æ•°è°ƒä¼˜**: f_maps=[4,8], num_levels=2, batch_size=1, max_iterations=3 (è°ƒè¯•æ¨¡å¼)
âœ… **è®­ç»ƒæµç¨‹éªŒè¯**: 3ä¸ªiterationså®Œæˆï¼ŒæŸå¤±æ­£å¸¸å˜åŒ–ï¼ŒGPUåŠ é€Ÿæ˜æ˜¾

### å…³é”®æŠ€æœ¯å†³ç­–
- **ä»»åŠ¡æ€§è´¨**: **ç‚«å…‰å»é™¤(Deflare)** - ä»background_with_flare_eventså»é™¤ç‚«å…‰å¾—åˆ°background_with_light_events
- **æ•°æ®è·¯å¾„**: `/mnt/e/2025/event_flick_flare/main/output/data_simu/physics_method/`
- **æ–‡ä»¶å‘½å**: `composed_XXXXX_bg_flare.h5` â†” `composed_XXXXX_bg_light.h5`
- **æ•°æ®ç‰¹ç‚¹**: ç›®å‰æ•°æ®é›†ä¸åˆ†train/test/inferenceï¼Œå…¨éƒ¨éƒ½æ˜¯è®­ç»ƒæ•°æ®

### ä¸‹ä¸€æ­¥è°ƒè¯•è®¡åˆ’
1. âœ… å¤§å¹…å‡å°æ¨¡å‹å‚æ•° (f_maps, num_levelsç­‰)
2. âœ… éªŒè¯æ•°æ®è¯»å–ç­–ç•¥ç¡®å®è¯»å–äº†physics_methodæ•°æ®
3. âœ… é€æ­¥ä¿®å¤è®­ç»ƒè¿‡ç¨‹ä¸­çš„bugs
4. âœ… ç¡®ä¿20msäº‹ä»¶æ•°æ®æ­£ç¡®voxelåŒ–ä¸º8æ®µ
5. **å¾…æµ‹è¯•**: æ–­ç‚¹ç»­å­˜èƒ½åŠ›éªŒè¯

### å¾…å®Œæˆçš„é‡è¦æµ‹è¯•
ğŸ”„ **æ–­ç‚¹ç»­å­˜æµ‹è¯•** (checkpoint resumeåŠŸèƒ½):
- **é—®é¢˜**: è®­ç»ƒå™¨éœ€è¦éªŒè¯checkpointä¿å­˜å’ŒåŠ è½½åŠŸèƒ½æ˜¯å¦æ­£å¸¸
- **æµ‹è¯•æ­¥éª¤**: 
  1. è¿è¡Œè®­ç»ƒä¿å­˜checkpoint (éœ€è¦ä¿®å¤åœ¨max_iterationsæ—¶çš„checkpointä¿å­˜é€»è¾‘)
  2. é…ç½®resumeå‚æ•°ä»checkpointç»§ç»­è®­ç»ƒ
  3. éªŒè¯æ¨¡å‹æƒé‡ã€ä¼˜åŒ–å™¨çŠ¶æ€ã€iterationè®¡æ•°ç­‰æ¢å¤æ­£ç¡®
- **çŠ¶æ€**: å‘ç°bug - è®­ç»ƒåœ¨max_iterationsç»“æŸæ—¶ä¸è§¦å‘checkpointä¿å­˜
- **ä¿®å¤**: å·²ä¿®æ”¹custom_trainer.pyåœ¨è®­ç»ƒç»“æŸå‰å¼ºåˆ¶ä¿å­˜final checkpoint
- **ä¸‹æ¬¡éªŒè¯**: è¿è¡Œå®Œæ•´æµ‹è¯•ç¡®ä¿resumeåŠŸèƒ½æ­£å¸¸å·¥ä½œ

## ä½¿ç”¨æŒ‡å—

### GPUç¯å¢ƒå‡†å¤‡ - **2025-01-03æ›´æ–°**
```bash
# æ¿€æ´»GPUç¯å¢ƒ (æ¯æ¬¡ä½¿ç”¨å‰)
eval "$(conda shell.bash hook)" && conda activate Umain

# éªŒè¯GPUç¯å¢ƒ
python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}'); print(f'CUDA device: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else \"N/A\"}')"

# éªŒè¯pytorch-3dunet
python -c "from pytorch3dunet.unet3d.model import UNet3D; print('pytorch-3dunet UNet3D available')"
```

**ç¯å¢ƒé…ç½®å†å²**:
- **åŸç¯å¢ƒ**: PyTorch 1.8.1 (CPU only)
- **å‡çº§è¿‡ç¨‹**: åˆ é™¤mamba â†’ condaå‡çº§ â†’ PyTorch 2.3.0 + CUDA 12.1 + pytorch-3dunet  
- **å½“å‰ç¯å¢ƒ**: RTX 4060 Laptop GPU + CUDA 12.1 + PyTorch 2.3.0

### æ•°æ®å‡†å¤‡
```bash
# ç»„ç»‡æ•°æ®ç›®å½•ç»“æ„
data/
â”œâ”€â”€ train/
â”‚   â”œâ”€â”€ noisy/     # å™ªå£°äº‹ä»¶H5æ–‡ä»¶
â”‚   â””â”€â”€ clean/     # å¹²å‡€äº‹ä»¶H5æ–‡ä»¶
â”œâ”€â”€ val/
â”‚   â”œâ”€â”€ noisy/
â”‚   â””â”€â”€ clean/
â””â”€â”€ test/
    â”œâ”€â”€ noisy/
    â””â”€â”€ clean/
```

### é…ç½®å®šåˆ¶
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹æ•°æ®è·¯å¾„
vim configs/train_config.yaml
# è°ƒæ•´æ¨¡å‹å‚æ•°ã€å­¦ä¹ ç‡ç­‰

vim configs/test_config.yaml 
# ä¿®æ”¹æµ‹è¯•æ•°æ®è·¯å¾„ã€è¯„ä¼°æŒ‡æ ‡

vim configs/inference_config.yaml
# è®¾ç½®æ¨¡å‹checkpointè·¯å¾„
```

### å®Œæ•´è®­ç»ƒæµç¨‹ - **GPUæ¨¡å¼éªŒè¯æˆåŠŸ**
```bash
# 1. æ•°æ®éªŒè¯ (å¯é€‰)
python debug_data_loading.py

# 2. GPUè®­ç»ƒæ¨¡å‹ (æå°å‚æ•°è°ƒè¯•)
python main.py train --config configs/train_config.yaml

# 3. è¯„ä¼°æ¨¡å‹
python main.py test --config configs/test_config.yaml

# 4. æ¨ç†åº”ç”¨
python main.py inference --config configs/inference_config.yaml \
  --input testdata/deflare_input.h5 --output results/deflared_output.h5
```

**å½“å‰è®­ç»ƒé…ç½®** (è°ƒè¯•æ¨¡å¼):
- **æ¨¡å‹**: UNet3D, f_maps=[4,8], 2 levels, 3,353å‚æ•°
- **æ•°æ®**: 500ä¸ªH5æ–‡ä»¶å¯¹, 2500ä¸ªè®­ç»ƒæ ·æœ¬ (20ms/8bins)
- **è®­ç»ƒ**: batch_size=1, max_iterations=3, GPUåŠ é€Ÿ
- **è®¾å¤‡**: RTX 4060 Laptop GPU, CUDA 12.1

è¿™ä¸ªç³»ç»Ÿå°†åŸæœ‰çš„ç¼–è§£ç å·¥å…·é“¾ä¸ç°ä»£æ·±åº¦å­¦ä¹ è®­ç»ƒæ¡†æ¶å®Œç¾ç»“åˆï¼Œå®ç°äº†**å·¥ç¨‹ç®€æ´æ€§**ä¸**åŠŸèƒ½å®Œæ•´æ€§**çš„ç»Ÿä¸€ã€‚

---

## ç¯å¢ƒå¯åŠ¨å‘½ä»¤

**å¿«é€Ÿå¯åŠ¨è™šæ‹Ÿç¯å¢ƒ** (æ¯æ¬¡ä½¿ç”¨å‰æ‰§è¡Œ):
```bash
cd /mnt/e/2025/event_flick_flare/Unet_main && eval "$(conda shell.bash hook)" && conda activate Umain
```

**ç¯å¢ƒéªŒè¯**:
```bash
python -c "import torch; print('CUDA available:', torch.cuda.is_available())"
python -c "import numpy, h5py, matplotlib; print('Dependencies OK')"
```