# Event-Voxel ç‚«å…‰å»é™¤ç³»ç»Ÿ - é¡¹ç›®è®°å½•

## é¡¹ç›®æ¦‚è¿°

åŸºäºResidualUNet3Dçš„**äº‹ä»¶ç‚«å…‰å»é™¤(Event Deflare)**è®­ç»ƒä¸æ¨ç†ç³»ç»Ÿï¼Œå®ç°ä»å«ç‚«å…‰äº‹ä»¶ä¸­å»é™¤ç‚«å…‰ï¼Œä¿ç•™èƒŒæ™¯å’Œå…‰æºäº‹ä»¶ã€‚

**æ•°æ®é›†è·¯å¾„ - 2025-09-04æ›´æ–°**: data_simuå·²è¿ç§»è‡³æœ¬åœ°é¡¹ç›®ç›®å½• `/mnt/e/2025/event_flick_flare/Unet_main/data_simu/`

## æ ¸å¿ƒè®¾è®¡å“²å­¦

åŸºäºLinus Torvaldsçš„"å¥½å“å‘³"åŸåˆ™ï¼š
- **æ•°æ®ç»“æ„æ­£ç¡®**: Events (N,4) â†’ Voxel (8,H,W) â†’ ResidualUNet3D â†’ å»ç‚«å…‰Voxel
- **æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ**: ç»Ÿä¸€20ms/8binsæ—¶é—´åˆ†è¾¨ç‡ï¼Œæ— å¤šå°ºåº¦å¤æ‚æ€§
- **å®ç”¨ä¸»ä¹‰**: è§£å†³çœŸå®ç‚«å…‰å»é™¤é—®é¢˜ï¼Œä¸è¿‡åº¦è®¾è®¡

## å½“å‰æ¶æ„ - **2025-01-03æœ€æ–°ç‰ˆæœ¬ + çœŸæ­£æ®‹å·®å­¦ä¹ **

### ä»»åŠ¡å®šä¹‰
- **è¾“å…¥**: `data_simu/physics_method/background_with_flare_events/` (å«ç‚«å…‰çš„èƒŒæ™¯äº‹ä»¶H5æ–‡ä»¶)  
- **è¾“å‡º**: `data_simu/physics_method/background_with_light_events/` (å¹²å‡€çš„èƒŒæ™¯+å…‰æºäº‹ä»¶H5æ–‡ä»¶)
- **å­¦ä¹ ç›®æ ‡**: çœŸæ­£æ®‹å·®å­¦ä¹  `output_voxel = input_voxel + residual_learned`ï¼Œå…¶ä¸­`residual â‰ˆ -flare_voxel`
- **æ•°æ®è§„æ¨¡**: è®­ç»ƒé›†500ä¸ªæ–‡ä»¶ï¼Œæµ‹è¯•é›†50ä¸ªæ–‡ä»¶

### æ•°æ®æµï¼ˆå…¨åœ¨voxelç©ºé—´ï¼‰
```
H5 Events (100ms) â†’ 5Ã—20ms Segments â†’ Voxel (1,8,480,640) â†’ TrueResidualUNet3D â†’ Deflared Voxel â†’ Events
                                                                       â†“
                                               input_voxel + backbone_network(input_voxel)
```

### æ ¸å¿ƒæŠ€æœ¯çªç ´ - **çœŸæ­£æ®‹å·®å­¦ä¹ **
1. **TrueResidualUNet3D**: ç«¯åˆ°ç«¯æ®‹å·®å­¦ä¹ ï¼Œåˆå§‹å®Œç¾æ’ç­‰æ˜ å°„
2. **é›¶åˆå§‹åŒ–**: æœ€åä¸€å±‚é›¶æƒé‡ï¼Œç¡®ä¿åˆå§‹æ—¶`output = input + 0 = input`
3. **èƒŒæ™¯ä¿æŠ¤**: åˆå§‹çŠ¶æ€100%ä¿æŒèƒŒæ™¯ï¼Œç½‘ç»œä¸“æ³¨å­¦ä¹ ç‚«å…‰å»é™¤
4. **æ¢¯åº¦æµç•…**: æ®‹å·®è¿æ¥ç¡®ä¿æ¢¯åº¦ç›´æ¥ä¼ é€’ï¼Œæ— æ¶ˆå¤±é£é™©
5. **èƒ½é‡ä¿æŒ**: åˆå§‹èƒ½é‡ä¿æŒç‡100%ï¼Œæ­£å€¼æ¯”ä¾‹100%â†’100%

## é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ data_processing/            # Eventsâ†”Voxelç¼–è§£ç 
â”‚   â”‚   â”œâ”€â”€ encode.py
â”‚   â”‚   â”œâ”€â”€ decode.py
â”‚   â”‚   â””â”€â”€ professional_visualizer.py
â”‚   â”œâ”€â”€ datasets/
â”‚   â”‚   â””â”€â”€ event_voxel_dataset.py  # EventVoxelDataset
â”‚   â”œâ”€â”€ training/
â”‚   â”‚   â”œâ”€â”€ training_factory.py     # ResidualUNet3Dæ¨¡å‹åˆ›å»º
â”‚   â”‚   â””â”€â”€ custom_trainer.py       # è‡ªå®šä¹‰è®­ç»ƒå¾ªç¯
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ config_loader.py
â”œâ”€â”€ configs/                        # è®­ç»ƒé…ç½®ç³»ç»Ÿ
â”‚   â”œâ”€â”€ train_config.yaml
â”‚   â”œâ”€â”€ test_config.yaml
â”‚   â””â”€â”€ inference_config.yaml
â””â”€â”€ main.py                         # é¡¹ç›®å…¥å£ (train/test/inference)
```

## å…³é”®æŠ€æœ¯è§£å†³æ–¹æ¡ˆ

### 1. pytorch-3dunet ResidualUNet3Dé—®é¢˜åˆ†æ - **å·²è§£å†³**

**å‘ç°çš„æ ¹æœ¬é—®é¢˜**:
- pytorch-3dunetçš„ResidualUNet3D **ä¸æ˜¯çœŸæ­£çš„ç«¯åˆ°ç«¯æ®‹å·®å­¦ä¹ **
- åˆå§‹çŠ¶æ€ï¼šèƒ½é‡ä¿æŒç‡-46%ï¼Œæ­£å€¼æ¯”ä¾‹100%â†’13.6%ï¼Œç›¸å¯¹å·®å¼‚148.7%
- å¤§é‡èƒŒæ™¯ä¿¡æ¯åœ¨åˆå§‹çŠ¶æ€å°±ä¸¢å¤±ï¼Œéœ€è¦å……åˆ†è®­ç»ƒæ‰èƒ½æ¢å¤

### 2. çœŸæ­£æ®‹å·®å­¦ä¹ å®ç° - **å…¨æ–°è§£å†³æ–¹æ¡ˆ**

**TrueResidualUNet3Dæ¶æ„**:
```python
class TrueResidualUNet3D(nn.Module):
    def forward(self, x):
        residual = self.backbone(x)  # å­¦ä¹ æ®‹å·® â‰ˆ -flare_voxel
        output = x + residual        # çœŸæ­£æ®‹å·®: output = input + residual
        return output
```

**é›¶åˆå§‹åŒ–æœºåˆ¶**:
```python
# æœ€åä¸€å±‚æƒé‡å’Œåç½®åˆå§‹åŒ–ä¸º0
nn.init.zeros_(last_conv.weight)
nn.init.zeros_(last_conv.bias)
# ç¡®ä¿åˆå§‹æ—¶: residual = 0, output = input (å®Œç¾æ’ç­‰æ˜ å°„)
```

**æµ‹è¯•éªŒè¯ç»“æœ**:
- åˆå§‹èƒ½é‡ä¿æŒç‡: **100.0%** âœ… (vs -46% âŒ)
- åˆå§‹æ­£å€¼æ¯”ä¾‹: **100%â†’100%** âœ… (vs 100%â†’13.6% âŒ)  
- åˆå§‹ç›¸å¯¹å·®å¼‚: **0.000%** âœ… (vs 148.7% âŒ)
- æ¢¯åº¦æµéªŒè¯: æœ€åå±‚æ¢¯åº¦èŒƒæ•°2.3ï¼Œè®­ç»ƒæ­£å¸¸

### 3. pytorch-3dunetæ¿€æ´»å‡½æ•°é—®é¢˜çš„å®Œæ•´è§£å†³æ–¹æ¡ˆ - **å…³é”®æŠ€æœ¯ç»†èŠ‚**

**é—®é¢˜æ ¹æº**:
```python
# pytorch-3dunetçš„æ¿€æ´»å‡½æ•°è®¾è®¡ç¼ºé™·
final_sigmoid=False â†’ Softmax(dim=1) â†’ å•é€šé“æ—¶è¾“å‡ºå…¨1 âŒ
final_sigmoid=True  â†’ Sigmoid()     â†’ è¾“å‡ºé™åˆ¶åœ¨[0,1] âŒ
```

**ä¸ºä»€ä¹ˆéœ€è¦å®æ•°åŸŸ(R)è¾“å‡º**:
1. **Voxelè¯­ä¹‰**: æ­£è´Ÿäº‹ä»¶ç´¯ç§¯ï¼Œå€¼åŸŸä¸ºæ•´ä¸ªå®æ•°è½´ `(-âˆ, +âˆ)`
2. **æ®‹å·®å­¦ä¹ **: éœ€è¦å­¦ä¹  `residual â‰ˆ -flare_noise`ï¼Œå¿…é¡»æ”¯æŒè´Ÿå€¼
3. **æ•°å€¼ç²¾åº¦**: Sigmoid[0,1]å‹ç¼©ç ´åvoxelçš„æ•°å€¼å«ä¹‰

**æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆ**:
```python
# å·§å¦™ç»•è¿‡pytorch-3dunetçš„é™åˆ¶:
final_sigmoid=True           # é¿å…Softmax(dim=1)çš„bug
model.final_activation = nn.Identity()  # å¼ºåˆ¶æ›¿æ¢ä¸ºæ’ç­‰æ˜ å°„
# ç»“æœ: è¾“å‡ºåŸŸ = Rï¼Œæ”¯æŒä»»æ„å®æ•°å€¼
```

**å®ç°ä½ç½®**: `src/training/training_factory.py:68-75`

## æ¨èè®­ç»ƒé…ç½® - **2025-01-03æ›´æ–°**

### æ¨¡å‹é€‰æ‹©ä¸å‚æ•°é‡åˆ†æ
**æ¨è**: `TrueResidualUNet3D` (çœŸæ­£æ®‹å·®å­¦ä¹ )

**å½“å‰é…ç½® vs å®˜æ–¹é»˜è®¤å¯¹æ¯”** - **å·²å‡çº§åˆ°ä¸­ç­‰è§„æ¨¡**:
| å‚æ•° | å®˜æ–¹é»˜è®¤ | ä¹‹å‰è½»é‡é…ç½® | **å½“å‰ä¸­ç­‰é…ç½®** | åŸå›  |
|-----|---------|------------|---------------|------|
| `f_maps` | 64 | [16, 32, 64] | **[32, 64, 128]** âœ… | **4å€ç‰¹å¾å›¾å®¹é‡ï¼Œæ›´å¼ºå­¦ä¹ èƒ½åŠ›** |
| `num_levels` | 5 | 3 | **3** | å¹³è¡¡æ·±åº¦ä¸æ•ˆç‡ |
| `num_groups` | 8 | 8 âœ… | **8** âœ… | GroupNormæ ‡å‡†è®¾ç½® |
| `layer_order` | 'gcr' | 'gcr' âœ… | **'gcr'** âœ… | GroupNorm+Conv+ReLU |
| `dropout_prob` | 0.1 | 0.1 âœ… | **0.1** âœ… | æ ‡å‡†æ­£åˆ™åŒ– |
| **æ€»å‚æ•°é‡** | **1.13äº¿** | 43ä¸‡ | **~173ä¸‡** | **4å€å­¦ä¹ èƒ½åŠ›æå‡** |

```yaml
# å½“å‰ä¸­ç­‰è§„æ¨¡é…ç½® (~173ä¸‡å‚æ•°) - 2025-01-03å·²éƒ¨ç½²
model:
  name: 'TrueResidualUNet3D'
  backbone: 'ResidualUNet3D'
  f_maps: [32, 64, 128]      # 4å€ç‰¹å¾å›¾å®¹é‡ï¼Œæ›´å¼ºå­¦ä¹ èƒ½åŠ›
  num_levels: 3              # ä¿æŒ3å±‚æ·±åº¦ï¼Œå¹³è¡¡æ•ˆç‡
  layer_order: 'gcr'         # GroupNorm + Conv + ReLU
  num_groups: 8              # GroupNormåˆ†ç»„
  conv_padding: 1            # å·ç§¯padding
  dropout_prob: 0.1          # Dropoutæ­£åˆ™åŒ–
```

**âœ… å‡çº§ä¼˜åŠ¿**: 173ä¸‡å‚æ•°æä¾›4å€å­¦ä¹ èƒ½åŠ›ï¼Œé€‚åˆå¤æ‚ç‚«å…‰æ¨¡å¼

**è¿›ä¸€æ­¥æ‰©å±•å»ºè®®**:
```yaml
# å¤§è§„æ¨¡é…ç½® (690ä¸‡å‚æ•°ï¼Œå¤æ‚ç‚«å…‰åœºæ™¯)
f_maps: [64, 128, 256]      # 16å€ç‰¹å¾å›¾å®¹é‡  
num_levels: 4               # æ·±åº¦ç‰¹å¾å­¦ä¹ 
```

**å‚æ•°é‡å¯¹æ¯”åˆ†æ**:
- **ä¹‹å‰è½»é‡**: 43ä¸‡å‚æ•° â†’ å¯èƒ½å­¦ä¹ èƒ½åŠ›ä¸è¶³ âš ï¸
- **å½“å‰ä¸­ç­‰**: 173ä¸‡å‚æ•° (4å€) â†’ **å¹³è¡¡æ€§èƒ½ä¸æ•ˆç‡** âœ… **å·²éƒ¨ç½²**
- **å¤§è§„æ¨¡**: 690ä¸‡å‚æ•° (16å€) â†’ å¼ºå­¦ä¹ èƒ½åŠ›ï¼Œéœ€æ›´å¤šæ•°æ® 

**GPUå†…å­˜å…¨éƒ¨å‹å¥½** (RTX 4060): æ‰€æœ‰é…ç½®éƒ½ <2GB æ¨¡å‹æƒé‡

### è®­ç»ƒå‚æ•°
- **æ•°æ®**: 500ä¸ªH5æ–‡ä»¶å¯¹ â†’ 2500ä¸ªè®­ç»ƒæ ·æœ¬  
- **è®­ç»ƒ**: batch_size=1, 50 epochs, MSELoss, Adamä¼˜åŒ–å™¨
- **è®¾å¤‡**: RTX 4060 Laptop GPU, CUDA 12.1
- **éªŒè¯**: æ¯2ä¸ªiterationéªŒè¯ä¸€æ¬¡ï¼Œå¿«é€Ÿåé¦ˆ

## ç¯å¢ƒé…ç½®

### GPUç¯å¢ƒ: Umain
- Python 3.9
- PyTorch 2.3.0 + CUDA 12.1 + pytorch-3dunet
- æ ¸å¿ƒä¾èµ–: numpy, h5py, matplotlib, opencv-python, scipy, pandas, pyyaml
- **Debugä¾èµ–**: OpenCV 4.10.0 + pandas 1.5.3 (professional_visualizeræ‰€éœ€)

### å¿«é€Ÿå¯åŠ¨ - **2025-09-04**
```bash
cd /mnt/e/2025/event_flick_flare/Unet_main && eval "$(conda shell.bash hook)" && conda activate Umain

# ç«‹å³å¯ç”¨ - æ— éœ€å¤–éƒ¨æ•°æ®
python main.py test --config configs/test_config.yaml --debug  # è¯„ä¼°checkpoint
python main.py train --config configs/train_config.yaml --debug  # è°ƒè¯•è®­ç»ƒ
```

## ä½¿ç”¨æŒ‡å— - **2025-09-04 æœ¬åœ°åŒ–å®Œæˆ**

**é‡è¦**: æ‰€æœ‰æ•°æ®å·²æœ¬åœ°åŒ–è‡³ `data_simu/physics_method/`ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–

### è®­ç»ƒ - **ä½¿ç”¨æœ¬åœ°æ•°æ®**
```bash
# æ­£å¸¸è®­ç»ƒ (500ä¸ªæœ¬åœ°è®­ç»ƒæ–‡ä»¶)
python main.py train --config configs/train_config.yaml

# Debugè®­ç»ƒæ¨¡å¼ (ç”Ÿæˆ6-8ä¸ªå¯è§†åŒ–æ–‡ä»¶å¤¹)
python main.py train --config configs/train_config.yaml --debug
```

### æµ‹è¯• - **å®Œå…¨é‡æ„ï¼Œæ”¯æŒcheckpointè¯„ä¼°**
```bash
# è¯„ä¼°2500 checkpoint (50ä¸ªæœ¬åœ°æµ‹è¯•æ–‡ä»¶)
python main.py test --config configs/test_config.yaml

# Debugæµ‹è¯•æ¨¡å¼ (æ™ºèƒ½é‡‡æ ·ï¼šæ¯5ä¸ªbatchå¯è§†åŒ–1ä¸ª)
python main.py test --config configs/test_config.yaml --debug
```

### æ¨ç† - **å¾…æ›´æ–°åˆ°æœ¬åœ°è·¯å¾„**
```bash
python main.py inference --config configs/inference_config.yaml \
  --input data_simu/some_file.h5 --output results/deflared_events.h5
```

### è®­ç»ƒæ—¥å¿—å¯è§†åŒ– - **2025-01-03æ–°å¢**
```bash
# åŸºç¡€ä½¿ç”¨ (æ¨è) - è‡ªåŠ¨ç”Ÿæˆlossæ›²çº¿
python visualize_training_logs.py

# è‡ªå®šä¹‰æ—¥å¿—è·¯å¾„å’Œè¾“å‡ºç›®å½•
python visualize_training_logs.py --log_dir logs/event_voxel_denoising --output_dir debug_output

# è¯¦ç»†åˆ†ææ¨¡å¼ (ç”Ÿæˆé¢å¤–çš„è¯¦ç»†åˆ†æå›¾è¡¨)
python visualize_training_logs.py --detailed
```


**åŠŸèƒ½ç‰¹æ€§** - **2025-09-04æ›´æ–°**:
- âœ… **è‡ªåŠ¨TensorBoardæ—¥å¿—è§£æ**: æ”¯æŒ2594ä¸ªbatch loss + epoch lossæ•°æ®ç‚¹
- âœ… **å¤šæŒ‡æ ‡ç›‘æ§**: è®­ç»ƒloss + å­¦ä¹ ç‡æ›²çº¿ + epochç»Ÿè®¡
- âœ… **å¯¹æ•°åˆ»åº¦å¯è§†åŒ–**: æ‰€æœ‰losså›¾è¡¨ä½¿ç”¨å¯¹æ•°åˆ»åº¦ï¼Œæ›´å¥½å±•ç¤ºè®­ç»ƒåŠ¨æ€
- âœ… **å¹³æ»‘æ›²çº¿åˆ†æ**: çº¢è‰²ç§»åŠ¨å¹³å‡çº¿çªå‡ºè®­ç»ƒè¶‹åŠ¿ï¼Œæ— å¤šä½™ç›´çº¿å¹²æ‰°
- âœ… **æœ€ä½³æ€§èƒ½æ˜¾ç¤º**: æ·¡ç»¿è‰²æ–‡æœ¬æ¡†æ ‡æ³¨æœ€ä½³epochæ€§èƒ½
- âœ… **ç»Ÿä¸€è¾“å‡º**: æ‰€æœ‰å›¾è¡¨ä¿å­˜åˆ°`debug_output/training_loss_curves.png`
- âœ… **è‹±æ–‡ç•Œé¢**: é¿å…å­—ä½“ä¹±ç é—®é¢˜ï¼Œä¸“ä¸šå±•ç¤º
- âœ… **æ— å¼¹çª—æ¨¡å¼**: ç›´æ¥ä¿å­˜ï¼Œä¸å¼¹å‡ºæ˜¾ç¤ºçª—å£

## æœ€æ–°çŠ¶æ€ - **2025-09-04æ›´æ–°**

âœ… **ç”Ÿäº§å°±ç»ªç³»ç»Ÿ**:
- TrueResidualUNet3D + çœŸæ­£æ®‹å·®å­¦ä¹  (173ä¸‡å‚æ•°)
- å®Œæ•´MLOps pipeline (è®­ç»ƒâ†’éªŒè¯â†’checkpointâ†’**æµ‹è¯•**)
- **å®Œå–„çš„æµ‹è¯•æ¨¡å¼**: æ”¯æŒcheckpointè¯„ä¼° + æ™ºèƒ½å¯è§†åŒ–
- **æœ¬åœ°åŒ–æ•°æ®ç®¡ç†**: data_simuå·²å®Œå…¨è¿ç§»è‡³æœ¬åœ°é¡¹ç›®ç›®å½•
- ç°ä»£åŒ–tqdmè¿›åº¦æ¡ + emojiè¾“å‡º
- åˆ†æ®µå†…å­˜ä¼˜åŒ– + å›ºå®šæ—¶é—´åˆ†è¾¨ç‡

âœ… **æµ‹è¯•æ¨¡å¼å®Œå–„** - **2025-09-04æ–°å¢**:
- **é…ç½®ç»Ÿä¸€**: test_config.yamlä¸train_config.yamlå®Œå…¨åŒ¹é…
- **æ•°æ®ä¸€è‡´**: ä½¿ç”¨ä¸è®­ç»ƒvalidationç›¸åŒçš„æ•°æ®è·¯å¾„
- **checkpointå…¼å®¹**: æ”¯æŒåŠ è½½ä»»æ„iterationçš„checkpoint
- **æ™ºèƒ½å¯è§†åŒ–**: æ¯5ä¸ªbatché‡‡æ ·1ä¸ªï¼Œè¦†ç›–æ‰€æœ‰æ–‡ä»¶

âœ… **æ•°æ®é›†æœ¬åœ°åŒ–** - **2025-09-04å®Œæˆ**:
- **è·¯å¾„è¿ç§»**: `/mnt/e/2025/event_flick_flare/main/output/data_simu/` â†’ `/mnt/e/2025/event_flick_flare/Unet_main/data_simu/`
- **è®­ç»ƒæ•°æ®**: 500ä¸ªH5æ–‡ä»¶å¯¹ (background_with_flare_events + background_with_light_events)
- **æµ‹è¯•æ•°æ®**: 50ä¸ªH5æ–‡ä»¶å¯¹ (background_with_flare_events_test + background_with_light_events_test)
- **é…ç½®æ›´æ–°**: æ‰€æœ‰configæ–‡ä»¶å·²æ›´æ–°ä¸ºæœ¬åœ°è·¯å¾„
- **ç‹¬ç«‹éƒ¨ç½²**: é¡¹ç›®ç°åœ¨å®Œå…¨è‡ªåŒ…å«ï¼Œæ— å¤–éƒ¨ä¾èµ–

### Debugæ¨¡å¼ - **2025-01-03æœ€æ–°å®ç° + çœŸæ­£æ®‹å·®å­¦ä¹ æ”¯æŒ**
âœ… **å¢å¼ºå¯è§†åŒ–debugç³»ç»Ÿ**:
- **ä½è€¦åˆè®¾è®¡**: åœ¨æ•°æ®äº§ç”Ÿçš„åœ°æ–¹è§¦å‘å¯è§†åŒ–é’©å­ï¼Œä¸ä¿®æ”¹Datasetè¿”å›å€¼
- **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«TrueResidualUNet3Dï¼Œæä¾›æ®‹å·®åˆ†æ
- **6-8ä¸ªå¯è§†åŒ–æ–‡ä»¶å¤¹**: æ ‡å‡†æ¨¡å‹6ä¸ªï¼ŒçœŸæ­£æ®‹å·®å­¦ä¹ 8ä¸ª
- **å¿«é€ŸéªŒè¯**: åªè¿è¡Œ1-2ä¸ªiterationï¼Œå¿«é€Ÿæ£€æŸ¥æ¨¡å‹å’Œæ•°æ®æµ
- **ä¸“ä¸šå¯è§†åŒ–**: å¤ç”¨å·²æœ‰çš„professional_visualizeræ¨¡å—ï¼Œæ¯ä¸ªeventsæ–‡ä»¶å¤¹åŒ…å«3D+2D+temporalå…¨å¥—å¯è§†åŒ–
- **ç»Ÿä¸€è¾“å‡º**: **æ‰€æœ‰debugä¿¡æ¯éƒ½è¾“å‡ºåˆ°`debug_output`ç›®å½•**

**çœŸæ­£æ®‹å·®å­¦ä¹ çš„8ä¸ªå¯è§†åŒ–æ–‡ä»¶å¤¹**:
```
debug_output/epoch_000_iter_000/
â”œâ”€â”€ 1_input_events/          # è¾“å…¥äº‹ä»¶ç»¼åˆå¯è§†åŒ– (3D+2D+temporal)
â”œâ”€â”€ 3_input_voxel/           # è¾“å…¥voxelæ—¶é—´binså¯è§†åŒ–
â”œâ”€â”€ 4_target_events/         # çœŸå€¼äº‹ä»¶ç»¼åˆå¯è§†åŒ– (3D+2D+temporal)
â”œâ”€â”€ 6_target_voxel/          # çœŸå€¼voxelæ—¶é—´binså¯è§†åŒ–
â”œâ”€â”€ 7_output_events/         # æœ€ç»ˆè¾“å‡ºäº‹ä»¶ (input+residual) å¯è§†åŒ–
â”œâ”€â”€ 8_residual_voxel/        # å­¦ä¹ æ®‹å·®voxelå¯è§†åŒ– â­æ–°å¢
â”œâ”€â”€ 8_residual_events/       # å­¦ä¹ æ®‹å·®eventså¯è§†åŒ– (å¦‚æœéé›¶) â­æ–°å¢  
â”œâ”€â”€ 9_output_voxel/          # æœ€ç»ˆè¾“å‡ºvoxelæ—¶é—´binså¯è§†åŒ–
â””â”€â”€ debug_summary.txt        # è°ƒè¯•æ€»ç»“ä¿¡æ¯ (å«æ®‹å·®åˆ†æ)
```

**æ®‹å·®åˆ†ææ—¥å¿—**:
```
ğŸ› True residual learning detected:
ğŸ›   Input mean: X.XXXX, std: X.XXXX
ğŸ›   Residual mean: X.XXXX, std: X.XXXX  
ğŸ›   Output mean: X.XXXX, std: X.XXXX
ğŸ›   Identity check: output â‰ˆ input + residual = True
```

**ä½¿ç”¨æ–¹æ³•**:
```bash
# çœŸæ­£æ®‹å·®å­¦ä¹  + debugæ¨¡å¼
python main.py train --config configs/train_config.yaml --debug

# è‡ªå®šä¹‰debugç›®å½•
python main.py train --config configs/train_config.yaml --debug --debug-dir my_custom_debug
```

**é…ç½®æ–‡ä»¶å»ºè®®**:

**å½“å‰éƒ¨ç½²é…ç½®** (configs/train_config.yaml - **å·²å‡çº§**):
```yaml
model:
  name: 'TrueResidualUNet3D'
  backbone: 'ResidualUNet3D'  
  f_maps: [32, 64, 128]       # 173ä¸‡å‚æ•°ï¼Œ4å€å­¦ä¹ èƒ½åŠ› âœ…å·²éƒ¨ç½²
  num_levels: 3               # ä¿æŒé«˜æ•ˆæ·±åº¦
  # ... å…¶ä»–å‚æ•°
```

**è¿›ä¸€æ­¥æ‰©å±•é€‰é¡¹** (å¦‚éœ€æ›´å¼ºå­¦ä¹ èƒ½åŠ›):
```yaml  
model:
  name: 'TrueResidualUNet3D'
  backbone: 'ResidualUNet3D'
  f_maps: [32, 64, 128]       # å½“å‰é…ç½® (173ä¸‡å‚æ•°)
  num_levels: 4               # å¯é€‰æ‹©æ›´æ·± â†’ ~250ä¸‡å‚æ•°
  # ... å…¶ä»–å‚æ•°ä¿æŒä¸å˜
```

**å¤§è§„æ¨¡é…ç½®** (å¤æ‚ç‚«å…‰åœºæ™¯):
```yaml
model:
  name: 'TrueResidualUNet3D' 
  backbone: 'ResidualUNet3D'
  f_maps: [64, 128, 256]      # 690ä¸‡å‚æ•°ï¼Œå¼ºå­¦ä¹ èƒ½åŠ›
  num_levels: 4
  # ... å…¶ä»–å‚æ•°ä¿æŒä¸å˜
```

**é‡è¦çº¦å®š**: **æ‰€æœ‰debugç›¸å…³çš„å¯è§†åŒ–è¾“å‡ºéƒ½ç»Ÿä¸€ä¿å­˜åˆ°`debug_output`ç›®å½•**ï¼ŒåŒ…æ‹¬ï¼š
- **è®­ç»ƒdebug**: 6-8ä¸ªç»¼åˆå¯è§†åŒ–æ–‡ä»¶å¤¹ï¼ˆTrueResidualUNet3Då¤š2ä¸ªæ®‹å·®æ–‡ä»¶å¤¹ï¼‰
- **æµ‹è¯•debug**: æ™ºèƒ½é‡‡æ ·å¯è§†åŒ–ï¼ˆæ¯5ä¸ªbatché‡‡æ ·1ä¸ªï¼Œè¦†ç›–æ‰€æœ‰æ–‡ä»¶ï¼‰
- æ™ºèƒ½æ®‹å·®åˆ†æå’Œæ’ç­‰æ˜ å°„éªŒè¯  
- debug_summary.txtè°ƒè¯•æ€»ç»“æ–‡ä»¶
- **è®­ç»ƒlosså¯è§†åŒ–å›¾è¡¨** (`training_loss_curves.png`) - **2025-01-03æ–°å¢**
- ä»»ä½•å…¶ä»–debugç›¸å…³çš„ä¸´æ—¶æ–‡ä»¶å’Œæ—¥å¿—

**å®ç°ä½ç½®**:
- `true_residual_wrapper.py`: TrueResidualUNet3Då®ç°+é›¶åˆå§‹åŒ–
- `src/training/training_factory.py`: æ¨¡å‹åˆ›å»ºæ”¯æŒä¸¤ç§æ¶æ„
- `src/training/custom_trainer.py`: æ™ºèƒ½debugå¯è§†åŒ–é’©å­ï¼ˆè®­ç»ƒæ¨¡å¼ï¼‰
- `main.py`: **æµ‹è¯•æ¨¡å¼debugå¯è§†åŒ–** - **2025-09-04æ–°å¢**
- `visualize_training_logs.py`: **è®­ç»ƒlosså¯è§†åŒ–å·¥å…·** - **2025-01-03æ–°å¢**
- **configs/***: **æ‰€æœ‰é…ç½®å·²æœ¬åœ°åŒ–** - **2025-09-04æ›´æ–°**

### æµ‹è¯•æ¨¡å¼è¯¦è§£ - **2025-09-04æ–°å¢**

âœ… **æ ¸å¿ƒåŠŸèƒ½**:
- **Checkpointè¯„ä¼°**: åŠ è½½ä»»æ„iterationçš„checkpointè¿›è¡Œæ€§èƒ½è¯„ä¼°
- **æ•°æ®å®Œæ•´æ€§**: ä¸train validationä½¿ç”¨ç›¸åŒæ•°æ®è·¯å¾„ï¼Œç¡®ä¿ä¸€è‡´æ€§
- **æ™ºèƒ½å¯è§†åŒ–**: debugæ¨¡å¼é‡‡ç”¨5:1é‡‡æ ·ç­–ç•¥ï¼Œæ¯ä¸ªæ–‡ä»¶å¯è§†åŒ–1ä¸ªä»£è¡¨æ€§segment

âœ… **ä½¿ç”¨åœºæ™¯**:
```bash
# è¯„ä¼°2500 iteration checkpointæ€§èƒ½
python main.py test --config configs/test_config.yaml

# è¯„ä¼° + æ™ºèƒ½å¯è§†åŒ– (52ä¸ªæ–‡ä»¶ Ã— 1ä¸ªå¯è§†åŒ– = 52ä¸ªæ–‡ä»¶å¤¹)
python main.py test --config configs/test_config.yaml --debug
```

âœ… **æ•°æ®å¤„ç†æµç¨‹**:
- **è¾“å…¥**: 52ä¸ªtestæ–‡ä»¶ â†’ 260ä¸ªsamples (52Ã—5 segments)
- **è¯„ä¼°**: å…¨éƒ¨260ä¸ªsamplesè®¡ç®—loss
- **å¯è§†åŒ–**: batch 0,5,10,15... (æ¯ä¸ªæ–‡ä»¶çš„ç¬¬1ä¸ªsegment)
- **è¾“å‡º**: å¹³å‡test loss + å¯é€‰çš„52ä¸ªå¯è§†åŒ–æ–‡ä»¶å¤¹

âœ… **é…ç½®è¦æ±‚**:
- `model`: å¿…é¡»ä¸è®­ç»ƒé…ç½®å®Œå…¨åŒ¹é…ï¼ˆTrueResidualUNet3D, f_maps, num_levelsç­‰ï¼‰
- `path`: checkpointæ–‡ä»¶è·¯å¾„ï¼ˆå¦‚`checkpoint_epoch_0000_iter_002500.pth`ï¼‰
- `val_noisy_dir`/`val_clean_dir`: ä¸train_configä¸­validationè·¯å¾„ä¸€è‡´
- **æœ¬åœ°æ•°æ®è·¯å¾„**: æ‰€æœ‰è·¯å¾„å·²æ›´æ–°ä¸ºæœ¬åœ°`data_simu/physics_method/`ç»“æ„

### é¡¹ç›®å®Œæ•´æ€§éªŒè¯ - **2025-09-04æ–°å¢**

âœ… **æ•°æ®é›†å®Œæ•´æ€§**:
```
data_simu/physics_method/
â”œâ”€â”€ background_with_flare_events/     # 500ä¸ªè®­ç»ƒæ–‡ä»¶ (å«ç‚«å…‰)
â”œâ”€â”€ background_with_light_events/     # 500ä¸ªè®­ç»ƒæ–‡ä»¶ (å»ç‚«å…‰ç›®æ ‡)  
â”œâ”€â”€ background_with_flare_events_test/  # 50ä¸ªæµ‹è¯•æ–‡ä»¶ (å«ç‚«å…‰)
â””â”€â”€ background_with_light_events_test/  # 50ä¸ªæµ‹è¯•æ–‡ä»¶ (å»ç‚«å…‰ç›®æ ‡)
```

âœ… **é…ç½®æ–‡ä»¶å®Œæ•´æ€§**:
- `configs/train_config.yaml` âœ… å·²æ›´æ–°æœ¬åœ°è·¯å¾„
- `configs/test_config.yaml` âœ… å·²æ›´æ–°æœ¬åœ°è·¯å¾„  
- `configs/inference_config.yaml` âœ… å·²æ›´æ–°æœ¬åœ°è·¯å¾„
- æ‰€æœ‰é…ç½®å·²éªŒè¯å¯æ­£å¸¸åŠ è½½

âœ… **Checkpointå¯ç”¨æ€§**:
- `checkpoint_epoch_0000_iter_002500.pth` âœ… å¯ç”¨äºæµ‹è¯•
- æ¨¡å‹é…ç½®: TrueResidualUNet3D, [32,64,128], 173ä¸‡å‚æ•°
- ä¸å½“å‰é…ç½®å®Œå…¨å…¼å®¹

## éªŒè¯ç»“æœä¸æŠ€æœ¯çªç ´

### ç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯
**æµ‹è¯•æ•°æ®**: 956,728äº‹ä»¶ (100ms) â†’ ç¼–ç  â†’ è§£ç  â†’ é‡ç¼–ç 
- **å®Œç¾ä¸€è‡´æ€§**: ä¸¤æ¬¡ç¼–ç voxelå®Œå…¨ç›¸åŒ (L1=0.000000, L2=0.000000, Max=0.000000)
- **ä¿¡æ¯ä¿æŒ**: åŸå§‹voxel sum = é‡ç¼–ç voxel sum (å®Œå…¨åŒ¹é…)
- **æ—¶é—´åˆ†å¸ƒ**: è§£ç æ—¶é—´æˆ³æ­£ç¡®è½åœ¨å¯¹åº”æ—¶é—´binå†…
- **ææ€§ä¿æŒ**: æ­£è´Ÿäº‹ä»¶æ¯”ä¾‹åœ¨ç¼–è§£ç ä¸­å®Œå…¨ä¸€è‡´

### ç®€åŒ–å®ç°çªç ´
1. **æ•°æ®ç»“æ„æ­£ç¡®**: Events (N,4) â†” Voxel (8,H,W)ï¼Œç›´æ¥å¯¹åº”æ— ç‰¹æ®Šæƒ…å†µ
2. **æ¨¡å—ç‹¬ç«‹æ€§**: ç¼–è§£ç æ¨¡å—å®Œå…¨ç‹¬ç«‹ï¼Œå¯å•ç‹¬è°ƒç”¨æµ‹è¯•
3. **é…ç½®é©±åŠ¨**: YAMLç»Ÿä¸€ç®¡ç†ï¼Œå‘½ä»¤è¡Œå¯è¦†ç›–
4. **ä¸“ä¸šå¯è§†åŒ–**: åŸºäºevent_utilsä¸“ä¸šåº“ï¼Œ100+å¼ åˆ†æå›¾

### å†…å­˜ä¼˜åŒ–æ•ˆæœ
- **åˆ†æ®µç­–ç•¥**: 100ms â†’ 5Ã—20msæ®µï¼Œæ˜¾å­˜å ç”¨å‡å°‘80%
- **æ•°æ®é‡å¯¹æ¯”**: 956Käº‹ä»¶ â†’ 200Käº‹ä»¶/æ®µ (21%å†…å­˜å ç”¨)
- **è®­ç»ƒç¨³å®šæ€§**: å¤§å¹…å‡å°‘OOMé”™è¯¯ï¼Œé€‚åˆGPUè®­ç»ƒ

### æ—¶é—´ä¸€è‡´æ€§ä¿è¯
- **å›ºå®šåˆ†è¾¨ç‡**: æ‰€æœ‰æ ·æœ¬20ms/8bins = 2.5ms/bin
- **æ³›åŒ–æ€§**: è®­ç»ƒæ¨ç†ä½¿ç”¨ç›¸åŒæ—¶é—´è¯­ä¹‰
- **é¿å…é—®é¢˜**: æ¶ˆé™¤è‡ªé€‚åº”æ—¶é—´é—´éš”å¯¼è‡´çš„æ³›åŒ–å¤±è´¥

---

## é‡è¦æŠ€æœ¯å‘ç° - **2025-09-04**

### GPUå†…å­˜å ç”¨åˆ†æ
**å…³é”®å‘ç°**: 1.73Må‚æ•°æ¨¡å‹å ç”¨8Gæ˜¾å­˜çš„çœŸå®åŸå› 
- **æ¨¡å‹å‚æ•°**: 0.01GB
- **æ¿€æ´»å†…å­˜**: 3.93GB (å‰å‘ä¼ æ’­æ—¶)  
- **ä¸»è¦ç“¶é¢ˆ**: 3Då·ç§¯æ¿€æ´»å­˜å‚¨ï¼Œä¸æ˜¯å‚æ•°æ•°é‡
- **è§£å†³æ–¹æ¡ˆ**: gradient checkpointingå¯å‡å°‘80%æ¿€æ´»å†…å­˜

### å‚æ•°é‡å¯¹æ¯”åˆ†æ
```
å½“å‰é…ç½® [32,64,128]: 1.73Må‚æ•° (å¯èƒ½ä¸è¶³)
æ¨èé…ç½® [64,128,256]: 6.90Må‚æ•° (4å€æå‡)
pytorch-3duneté»˜è®¤: 113.74Må‚æ•° (66å€)
åŒ»å­¦å»å™ªå…¸å‹: 5-50Må‚æ•°èŒƒå›´
```

**ç»“è®º**: å‚æ•°ä¸è¶³å¯èƒ½æ˜¯æ•ˆæœä¸ä½³çš„ä¸»è¦åŸå› 

## æ˜¾å­˜ä¼˜åŒ–ä¸æ¨¡å‹å‡çº§ - **2025-09-04é‡å¤§æ›´æ–°**

### **Gradient CheckpointingæˆåŠŸå®æ–½**

âœ… **é—®é¢˜è¯Šæ–­å®Œæˆ**:
- **æ¨¡å‹å®¹é‡ä¸è¶³**: 173ä¸‡å‚æ•° vs åŒ»å­¦æ ‡å‡†5-50Må‚æ•°
- **æ˜¾å­˜å ç”¨åˆ†æ**: æ¿€æ´»å†…å­˜3.93GBå 99.7% vs å‚æ•°å†…å­˜0.01GBå 0.3%
- **è®­ç»ƒæ•ˆæœå·®**: éªŒè¯æ ·æœ¬è¿‡å°‘(10ä¸ª) + é…ç½®éœ€ä¼˜åŒ–

âœ… **è§£å†³æ–¹æ¡ˆå®æ–½**:
1. **æ¨¡å‹å®¹é‡å‡çº§**: `[32,64,128]` â†’ `[48,96,144]` (288ä¸‡å‚æ•°, 1.7å€æå‡)
2. **Gradient Checkpointing**: å¯ç”¨å†…å­˜ä¼˜åŒ–ï¼Œé¢„æœŸ-60-80%æ¿€æ´»å†…å­˜
3. **é…ç½®æ–‡ä»¶æ›´æ–°**: `use_checkpoint: true` å·²æ·»åŠ åˆ°train_config.yaml

### **æŠ€æœ¯å®ç°ç»†èŠ‚**

**ä»£ç ä¿®æ”¹ä½ç½®**:
- `true_residual_wrapper.py`: æ·»åŠ `use_checkpoint`å‚æ•°å’Œæ¡ä»¶å‰å‘ä¼ æ’­
- `configs/train_config.yaml`: å‡çº§f_mapsé…ç½®å¹¶å¯ç”¨checkpointing

**å…³é”®ä»£ç **:
```python
def forward(self, x):
    if self.use_checkpoint and self.training:
        # è®­ç»ƒæ¨¡å¼: é‡æ–°è®¡ç®—æ¢å†…å­˜ (-60-80%æ˜¾å­˜)
        residual = checkpoint(self.backbone, x)
    else:
        # æ¨ç†æ¨¡å¼: æ ‡å‡†å‰å‘ä¼ æ’­ (æ— å†…å­˜å‹åŠ›)
        residual = self.backbone(x)
    return x + residual
```

**é…ç½®æ›´æ–°**:
```yaml
model:
  f_maps: [48, 96, 144]      # 288ä¸‡å‚æ•° (vs 173ä¸‡)
  use_checkpoint: true       # æ˜¾å­˜ä¼˜åŒ–
```

### **é¢„æœŸæ•ˆæœä¸æƒè¡¡**

| ä¼˜åŒ–é¡¹ | æ”¹å–„ | ä»£ä»· |
|-------|------|------|
| **æ¨¡å‹å®¹é‡** | +67%å­¦ä¹ èƒ½åŠ› | ç•¥å¢å‚æ•°å†…å­˜ |
| **æ¿€æ´»å†…å­˜** | -60-80%æ˜¾å­˜å ç”¨ | +20-50%è®­ç»ƒæ—¶é—´ |
| **æ€»ä½“æ•ˆæœ** | æ›´å¼ºæ¨¡å‹+å†…å­˜å‹å¥½ | å¯æ¥å—çš„æ—¶é—´å¢åŠ  |

### **éªŒè¯ç»“æœ**

âœ… **åŠŸèƒ½éªŒè¯**: 288ä¸‡å‚æ•°æ¨¡å‹æˆåŠŸåˆ›å»º
âœ… **CheckpointingéªŒè¯**: è®­ç»ƒ/æ¨ç†æ¨¡å¼æ­£ç¡®åˆ‡æ¢
âœ… **ä¸€è‡´æ€§éªŒè¯**: ä¸¤ç§æ¨¡å¼è¾“å‡ºå®Œå…¨ä¸€è‡´
âœ… **å†…å­˜å®‰å…¨**: RTX 4060 8GBå®Œå…¨å…¼å®¹

### **åç»­å‡çº§è·¯å¾„**

å¦‚éœ€æ›´å¼ºå­¦ä¹ èƒ½åŠ›:
```yaml
# è¿›ä¸€æ­¥å‡çº§é€‰é¡¹
f_maps: [64, 128, 256]  # 690ä¸‡å‚æ•°ï¼Œ4å€æå‡
num_levels: 4           # æ›´æ·±ç½‘ç»œ
```

### è®­ç»ƒå¯è§†åŒ–ç³»ç»Ÿä¼˜åŒ– - **2025-09-04**

âœ… **visualize_training_logs.py é‡è¦æ›´æ–°**:
- **å¯¹æ•°åˆ»åº¦æ˜¾ç¤º**: æ‰€æœ‰æŸå¤±å›¾è¡¨ä½¿ç”¨å¯¹æ•°åˆ»åº¦ï¼Œæ›´å¥½å±•ç¤ºè®­ç»ƒåŠ¨æ€å’Œæ—©æœŸå˜åŒ–
- **å¹³æ»‘æ›²çº¿ä¿ç•™**: ä¿ç•™çº¢è‰²ç§»åŠ¨å¹³å‡çº¿ä»¥æ˜¾ç¤ºè®­ç»ƒè¶‹åŠ¿
- **åˆ é™¤å¹²æ‰°å…ƒç´ **: ç§»é™¤çº¢è‰²ç®­å¤´æ³¨é‡Šï¼Œé¿å…æ˜¾ç¤ºä¸ºå¥‡æ€ªçš„ç›´çº¿
- **æ€§èƒ½æ ‡æ³¨ä¼˜åŒ–**: ä½¿ç”¨æ·¡ç»¿è‰²æ–‡æœ¬æ¡†æ˜¾ç¤ºæœ€ä½³epochï¼Œæ— ç®­å¤´å¹²æ‰°
- **æ•°æ®é‡æ›´æ–°**: æ”¯æŒ2594ä¸ªbatchæ•°æ®ç‚¹çš„å®Œæ•´è§£æå’Œå¯è§†åŒ–

**æŠ€æœ¯ç»†èŠ‚**:
```python
# ä¸»è¦æŸå¤±æ›²çº¿ - å¯¹æ•°åˆ»åº¦
ax1.set_yscale('log')  # çªå‡ºè®­ç»ƒåŠ¨æ€
ax1.plot(steps, losses, 'b-')     # è“è‰²åŸå§‹æ•°æ®
ax1.plot(smooth_steps, smoothed, 'r-')  # çº¢è‰²å¹³æ»‘æ›²çº¿

# EpochæŸå¤± - å¯¹æ•°åˆ»åº¦ + æ–‡æœ¬æ ‡æ³¨
ax2.set_yscale('log')
ax2.text(..., bbox=dict(facecolor='lightgreen'))  # æ— ç®­å¤´å¹²æ‰°
```

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. ç¼–ç å™¨ (src/data_processing/encode.py)

**æ•°æ®åŠ è½½**: `load_h5_events(file_path)`
- **è¾“å…¥**: H5æ–‡ä»¶è·¯å¾„
- **è¾“å‡º**: NumPyæ•°ç»„ (N, 4) [t, x, y, p]
- **ææ€§å‡†åˆ™**: **1â†’æ­£äº‹ä»¶(+1), é1â†’è´Ÿäº‹ä»¶(-1)** (é€šç”¨å¤„ç†å„ç§æ ¼å¼)

**æ ¸å¿ƒç¼–ç **: `events_to_voxel(events_np, num_bins=8, sensor_size, fixed_duration_us=20000)`
- **ç®—æ³•**: ç®€å•ç´¯ç§¯ï¼Œæ­£è´Ÿäº‹ä»¶åˆ†åˆ«å¤„ç†
- **å›ºå®šæ—¶é—´**: ç¡®ä¿è®­ç»ƒä¸€è‡´æ€§ï¼Œé¿å…æ³›åŒ–é—®é¢˜
- **åˆ†æ®µç­–ç•¥**: 100ms â†’ 5Ã—20msæ®µï¼Œæ¯æ®µ8ä¸ªbins

**ç‹¬ç«‹æ‰§è¡Œ**:
```bash
python src/data_processing/encode.py --input_file test.h5 --output_voxel_file output.pt --debug
```

### 2. è§£ç å™¨ (src/data_processing/decode.py)

**æ ¸å¿ƒè§£ç **: `voxel_to_events(voxel, total_duration, sensor_size)`
- **ç®—æ³•**: å‡åŒ€éšæœºåˆ†å¸ƒè§£ç ï¼ŒåŸºäºç‰©ç†æ„ä¹‰
- **æµç¨‹**: æµ®ç‚¹â†’æ•´æ•°â†’ç”Ÿæˆäº‹ä»¶â†’éšæœºæ—¶é—´æˆ³
- **ç«¯åˆ°ç«¯éªŒè¯**: ç¼–è§£ç pipelineå®Œå…¨å¯é€† (L1=L2=0.000000)

**ç‹¬ç«‹æ‰§è¡Œ**:
```bash
python src/data_processing/decode.py --input_voxel_file input.pt --output_file output.h5 --debug
```

### 3. ä¸“ä¸šå¯è§†åŒ–ç³»ç»Ÿ (src/data_processing/professional_visualizer.py)

**è®¾è®¡ç†å¿µ** (éµå¾ªLinus**"ç”¨å·²æœ‰å¥½å·¥å…·"**åŸåˆ™):
- åŸºäºevent_utils-masterä¸“ä¸šåº“ï¼Œä¸é‡å¤é€ è½®å­
- æ”¯æŒä»»æ„é˜¶æ®µçš„eventså’Œvoxelæ•°æ®å¯è§†åŒ–
- è‡ªåŠ¨å¤„ç†å…¼å®¹æ€§å’Œé”™è¯¯å®¹å¿

**å®Œæ•´6å¯è§†åŒ–æ¶æ„** (2Ã—2+2):
1. **è¾“å…¥Events 3Dæ—¶ç©ºå¯è§†åŒ–**: åŸç”Ÿ3Dæ•£ç‚¹å›¾ + æ—¶é—´çª—å£åºåˆ—
2. **è¾“å…¥Events 2Dçº¢è“æ—¶åº**: çº¢è“ææ€§æ˜¾ç¤º (çº¢=æ­£äº‹ä»¶ï¼Œè“=è´Ÿäº‹ä»¶)
3. **è¾“å‡ºEvents 3Dæ—¶ç©ºå¯è§†åŒ–**: è§£ç åeventsçš„3Dåˆ†æ
4. **è¾“å‡ºEvents 2Dçº¢è“æ—¶åº**: ä¸è¾“å…¥å¯¹æ¯”çš„2Dæ—¶åºå›¾
5. **è¾“å…¥Voxelå¯è§†åŒ–**: æ—¶é—´binå±•ç¤º + ç»Ÿè®¡åˆ†æ
6. **è¾“å‡ºVoxelå¯è§†åŒ–**: é‡ç¼–ç voxelå¯¹æ¯”åˆ†æ

**å…³é”®æ¥å£**:
```python
# å®Œæ•´pipelineå¯è§†åŒ– (æ¨è)
from src.data_processing.professional_visualizer import visualize_complete_pipeline
visualize_complete_pipeline(
    input_events=input_events_np,
    input_voxel=input_voxel_tensor,
    output_events=output_events_np,
    output_voxel=output_voxel_tensor,
    sensor_size=(480, 640),
    output_dir="debug_output",
    segment_idx=1  # å¯è§†åŒ–æ®µç´¢å¼•: 0-4å¯¹åº”ä¸åŒ20msæ®µ
)

# å•ç‹¬å¯è§†åŒ–
from src.data_processing.professional_visualizer import visualize_events_and_voxel
visualize_events_and_voxel(events_np, voxel_tensor, sensor_size, "debug_output", "batch_name")
```

**åˆ†æ®µå†…å­˜ä¼˜åŒ–ç‰¹æ€§**:
- **100ms â†’ 20msæ®µ**: æ•°æ®é‡å‡å°‘åˆ°21%ï¼Œé¿å…æ˜¾å­˜çˆ†ç‚¸
- **æ—¶é—´ä¸€è‡´æ€§**: è¾“å…¥è¾“å‡ºä½¿ç”¨ç›¸åŒæ—¶é—´æ®µè¿›è¡Œå¯¹æ¯”
- **ä¸“ä¸šè¾“å‡º**: æ‰€æœ‰å¯è§†åŒ–ç»Ÿä¸€ä¿å­˜åˆ°debug_outputç›®å½•
- **segment_idxå‚æ•°**: é€‰æ‹©ä¸åŒæ—¶é—´æ®µ (0=0-20ms, 1=10-30ms, 2=20-40msç­‰)

**è¾“å‡ºæ–‡ä»¶ç»“æ„ç¤ºä¾‹** (Segment 1: 10-30ms):
```
debug_output/
â”œâ”€â”€ input_events_seg1_native_3d_spatiotemporal.png
â”œâ”€â”€ input_events_seg1_2d_temporal/  # 2Dçº¢è“æ—¶åºå›¾
â”œâ”€â”€ input_voxel_seg1_temporal_bins.png
â”œâ”€â”€ output_events_seg1_native_3d_spatiotemporal.png
â”œâ”€â”€ output_events_seg1_2d_temporal/ # å¯¹æ¯”2Dæ—¶åºå›¾
â””â”€â”€ output_voxel_seg1_temporal_bins.png
```

### 4. æ•°æ®é›†ç³»ç»Ÿ (src/datasets/event_voxel_dataset.py)

**EventVoxelDatasetæ ¸å¿ƒåŠŸèƒ½**:
- **é…å¯¹æ•°æ®**: è‡ªåŠ¨æ‰«æåŒ¹é…noisy/cleanäº‹ä»¶æ–‡ä»¶å¯¹
- **åˆ†æ®µå¤„ç†**: æ¯ä¸ª100msæ–‡ä»¶äº§ç”Ÿ5ä¸ªè®­ç»ƒæ ·æœ¬ (5Ã—20msæ®µ)
- **æ ¼å¼è½¬æ¢**: Events â†’ Voxel â†’ (1,8,H,W) pytorchæ ¼å¼
- **å†…å­˜å‹å¥½**: 20msæ®µå¤„ç†ï¼Œé¿å…OOMé—®é¢˜

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from src.datasets.event_voxel_dataset import EventVoxelDataset

dataset = EventVoxelDataset(
    noisy_events_dir="/path/to/background_with_flare_events",
    clean_events_dir="/path/to/background_with_light_events",
    sensor_size=(480, 640),
    segment_duration_us=20000,  # 20msæ®µ
    num_bins=8,                 # 8ä¸ªæ—¶é—´bins
    num_segments=5              # 5ä¸ªæ®µperæ–‡ä»¶
)

# è¿”å›æ ¼å¼: {'raw': (1,8,480,640), 'label': (1,8,480,640)}
```

## æ ¸å¿ƒç¼–è§£ç æ¥å£

### Events â†’ Voxel ç¼–ç 
```python
from src.data_processing.encode import events_to_voxel
voxel = events_to_voxel(events_np, num_bins=8, sensor_size=(480,640), fixed_duration_us=20000)
```

### Voxel â†’ Events è§£ç   
```python
from src.data_processing.decode import voxel_to_events
events = voxel_to_events(voxel, total_duration=20000, sensor_size=(480,640))
```

### ç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯
```python
# éªŒè¯ç¼–è§£ç ä¸€è‡´æ€§
python -c "
from src.data_processing import encode, decode
events1 = encode.load_h5_events('test.h5')
voxel = encode.events_to_voxel(events1, num_bins=8, sensor_size=(480,640))
events2 = decode.voxel_to_events(voxel, total_duration=20000, sensor_size=(480,640))
voxel2 = encode.events_to_voxel(events2, num_bins=8, sensor_size=(480,640))
print(f'ä¸€è‡´æ€§éªŒè¯: L1={torch.nn.L1Loss()(voxel, voxel2):.6f}')
"
```

## çœŸæ­£æ®‹å·®å­¦ä¹ vsä¼ ç»Ÿæ–¹æ³•å¯¹æ¯”

### å…³é”®æŒ‡æ ‡å¯¹æ¯”è¡¨

| æŒ‡æ ‡ | pytorch-3dunet ResidualUNet3D | TrueResidualUNet3D (é›¶åˆå§‹åŒ–) |
|-----|------------------------------|------------------------------|
| **æ¶æ„è®¾è®¡** | å†…éƒ¨skip connections | ç«¯åˆ°ç«¯æ®‹å·®å­¦ä¹  `output = input + residual` |
| **åˆå§‹èƒ½é‡ä¿æŒ** | -46% âŒ | **100.0%** âœ… |
| **åˆå§‹æ­£å€¼ä¿æŒ** | 100%â†’13.6% âŒ | **100%â†’100%** âœ… |
| **åˆå§‹ç›¸å¯¹å·®å¼‚** | 148.7% âŒ | **0.000%** âœ… |
| **èƒŒæ™¯ä¿æŠ¤** | ä¸¥é‡ä¸¢å¤± âŒ | **å®Œå…¨ä¿æŠ¤** âœ… |
| **æ¢¯åº¦æµ** | ä¼ ç»ŸUNetæ¢¯åº¦ | **æ®‹å·®ç›´æ¥ä¼ é€’** âœ… |
| **è®­ç»ƒç¨³å®šæ€§** | éœ€å­¦ä¼šé‡å»ºèƒŒæ™¯ | **ä¸“æ³¨å­¦ä¹ å»ç‚«å…‰** âœ… |

### æ¨èè¿ç§»è·¯å¾„

1. **ç«‹å³åˆ‡æ¢**: é…ç½®æ–‡ä»¶`model.name: 'TrueResidualUNet3D'`
2. **ä¿æŒè®­ç»ƒä»£ç **: æ— éœ€ä¿®æ”¹è®­ç»ƒå¾ªç¯
3. **è§‚å¯Ÿdebugç»“æœ**: å¯¹æ¯”æ®‹å·®å­¦ä¹ æ•ˆæœ
4. **é¢„æœŸæ•ˆæœ**: åˆå§‹çŠ¶æ€å°±æœ‰åˆç†è¾“å‡ºï¼Œè®­ç»ƒæ›´ç¨³å®š

---

è¿™ä¸ªç³»ç»Ÿå®ç°äº†**çœŸæ­£æ®‹å·®å­¦ä¹ **ã€**èƒŒæ™¯ä¿¡æ¯ä¿æŠ¤**å’Œ**å·¥ç¨‹ç®€æ´æ€§**çš„ç»Ÿä¸€ï¼ŒåŸºäºLinus"å¥½å“å‘³"åŸåˆ™è§£å†³äº‹ä»¶ç‚«å…‰å»é™¤çš„å®é™…é—®é¢˜ã€‚

**æ ¸å¿ƒçªç ´**: è®©ç½‘ç»œä»å®Œç¾æ’ç­‰æ˜ å°„å¼€å§‹ï¼Œä¸“æ³¨å­¦ä¹ éœ€è¦å»é™¤çš„ç‚«å…‰ï¼Œè€Œä¸æ˜¯é‡å»ºæ•´ä¸ªèƒŒæ™¯ã€‚