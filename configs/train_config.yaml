# Training Configuration for Event-Voxel DEFLARE (炫光去除) with Custom Training System
# Task: Remove flare from background_with_flare_events → background_with_light_events

# Data loading configuration for custom training system
loaders:
  # Real deflare dataset paths (WSL format)
  train_noisy_dir: "/mnt/e/2025/event_flick_flare/main/output/data_simu/physics_method/background_with_flare_events"
  train_clean_dir: "/mnt/e/2025/event_flick_flare/main/output/data_simu/physics_method/background_with_light_events"
  val_noisy_dir: "/mnt/e/2025/event_flick_flare/main/output/data_simu/physics_method/background_with_flare_events_test"
  val_clean_dir: "/mnt/e/2025/event_flick_flare/main/output/data_simu/physics_method/background_with_light_events_test"
  
  # DataLoader parameters
  batch_size: 1           # 单样本batch (避免显存爆炸)
  num_workers: 0          # 单线程避免并发问题
  
  # Event-Voxel conversion parameters  
  sensor_size: [480, 640]         # DSEC sensor resolution
  segment_duration_us: 20000      # 20ms per segment
  num_bins: 8                     # 8 temporal bins per segment
  num_segments: 5                 # 5 segments per 100ms file
  
  # Data transforms (handled by EventVoxelDataset internally)
  transform: null

# Dataset-specific configuration (HDF5Dataset parameters)
# Note: Our test data is already in (8, 480, 640) format - no additional processing needed

# 3D Residual U-Net model configuration
model:
  name: ResidualUNet3D      # Residual 3D U-Net for deflare (better for residual learning)
  # Input/output channels
  in_channels: 1            # Single channel input (voxel grid)
  out_channels: 1           # Single channel output (deflared voxel)
  
  # Architecture parameters (合理的最小配置)
  f_maps: [16, 32, 64]      # 合理的特征图 (3层: 16->32->64)
  layer_order: gcr          # Group normalization + Conv + ReLU
  num_groups: 8             # 标准组数
  num_levels: 3             # 3层应该足够了
  final_sigmoid: true      # 强制设为true，代码中会替换为Identity
  
  # Advanced options (minimal)
  conv_kernel_size: 3       # Convolution kernel size
  pool_kernel_size: 2       # Pooling kernel size

# Loss function configuration
loss:
  name: MSELoss             # Mean Squared Error for regression (deflare)
  # Alternative losses for experimentation:
  # name: L1Loss            # Mean Absolute Error  
  # name: SmoothL1Loss      # Less sensitive to outliers

# Optimizer configuration
optimizer:
  name: Adam
  learning_rate: 0.0002     # Learning rate
  weight_decay: 0.00001     # L2 regularization

# Learning rate scheduler
lr_scheduler:
  name: MultiStepLR
  milestones: [10, 20, 30]  # Epochs to reduce LR
  gamma: 0.2                # LR reduction factor

# Training process configuration
trainer:
  # Checkpointing
  checkpoint_dir: checkpoints/event_voxel_deflare
  resume: null              # Path to resume from checkpoint (null = start from scratch)
  
  # Training duration
  max_num_epochs: 50        # 正常训练50个epochs
  max_num_iterations: null  # 无iteration限制，按epoch训练
  
  # Validation and logging
  validate_after_iters: 1250  # 每1250个iteration验证一次 (快速反馈)
  log_after_iters: 250       # 每1个iteration记录日志到tensorboard
  max_num_workers: 0         # 单线程避免并发问题
  
  # Early stopping (optional)
  # eval_score_higher_is_better: false  # For loss-based metrics (MSE, L1)

# Evaluation metrics during training  
eval_metric:
  name: MSE                 # Use MSE instead of MeanSquaredError
  # Additional metrics can be added:
  # - name: PSNR            # Peak Signal-to-Noise Ratio

# Logging and monitoring
logger:
  name: TensorBoardLogger
  log_dir: logs/event_voxel_denoising

# Device configuration
device: cuda               # 必须使用GPU，不允许CPU模式

# Random seed for reproducibility  
manual_seed: 42

# Data format specifications (for pytorch-3dunet compatibility)
# Input format: (batch_size, channels, depth, height, width)
# Our format: (batch_size, 1, 8, 480, 640) 
#   - batch_size: Variable
#   - channels: 1 (single voxel channel)  
#   - depth: 8 (temporal bins for 20ms segment)
#   - height: 480 (sensor height)
#   - width: 640 (sensor width)